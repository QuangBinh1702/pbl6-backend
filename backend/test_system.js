/**
 * TEST H·ªÜ TH·ªêNG SAU KHI C·∫¨P NH·∫¨T
 * Ki·ªÉm tra c√°c API endpoints v√† d·ªØ li·ªáu
 * 
 * CH·∫†Y: node test_system.js
 */

require('dotenv').config();
const mongoose = require('mongoose');

console.log('\n' + '='.repeat(70));
console.log('üß™ TEST H·ªÜ TH·ªêNG SAU KHI C·∫¨P NH·∫¨T');
console.log('='.repeat(70) + '\n');

// K·∫øt n·ªëi MongoDB
async function connectDB() {
  const mongoUri = process.env.MONGODB_URI || 'mongodb://localhost:27017';
  const dbName = process.env.MONGODB_NAME || 'pbl6';
  
  let connectionString;
  if (mongoUri.includes('mongodb+srv://') || mongoUri.includes('mongodb://')) {
    connectionString = mongoUri;
    await mongoose.connect(connectionString, { dbName });
  } else {
    connectionString = `${mongoUri}/${dbName}`;
    await mongoose.connect(connectionString);
  }
  
  console.log(`‚úÖ K·∫øt n·ªëi MongoDB th√†nh c√¥ng! Database: ${mongoose.connection.name}\n`);
}

// Import c√°c models
const User = require('./src/models/user.model');
const Role = require('./src/models/role.model');
const Permission = require('./src/models/permission.model');
const Action = require('./src/models/action.model');
const RoleAction = require('./src/models/role_action.model');
const UserRole = require('./src/models/user_role.model');
const UserActionOverride = require('./src/models/user_action_override.model');
const Field = require('./src/models/field.model');
const Falcuty = require('./src/models/falcuty.model');
const Cohort = require('./src/models/cohort.model');
const Class = require('./src/models/class.model');
const OrgUnit = require('./src/models/org_unit.model');
const StaffProfile = require('./src/models/staff_profile.model');
const StudentProfile = require('./src/models/student_profile.model');
const Activity = require('./src/models/activity.model');
const ActivityRegistration = require('./src/models/activity_registration.model');
const ActivityEligibility = require('./src/models/activity_eligibility.model');
const Attendance = require('./src/models/attendance.model');
const Evidence = require('./src/models/evidence.model');
const StudentFeedback = require('./src/models/student_feedback.model');
const StudentCohort = require('./src/models/student_cohort.model');
const PVCDRecord = require('./src/models/pvcd_record.model');
const Post = require('./src/models/post.model');

// Test functions
async function testModels() {
  console.log('üîç KI·ªÇM TRA MODELS...');
  
  try {
    // Test User model
    const users = await User.find({}).limit(5);
    console.log(`‚úÖ User model: ${users.length} users found`);
    if (users.length > 0) {
      console.log(`   - Sample user: ${users[0].username}`);
      console.log(`   - Has password_hash: ${!!users[0].password_hash}`);
    }

    // Test Permission model
    const permissions = await Permission.find({}).limit(5);
    console.log(`‚úÖ Permission model: ${permissions.length} permissions found`);
    if (permissions.length > 0) {
      console.log(`   - Sample permission: ${permissions[0].name}`);
      console.log(`   - Resource: ${permissions[0].resource}`);
      console.log(`   - Description: ${permissions[0].description || 'N/A'}`);
    }

    // Test Activity model
    const activities = await Activity.find({}).limit(5);
    console.log(`‚úÖ Activity model: ${activities.length} activities found`);
    if (activities.length > 0) {
      console.log(`   - Sample activity: ${activities[0].title}`);
      console.log(`   - Has org_unit_id: ${!!activities[0].org_unit_id}`);
      console.log(`   - Has field_id: ${!!activities[0].field_id}`);
    }

    // Test Staff Profile model
    const staffProfiles = await StaffProfile.find({}).limit(5);
    console.log(`‚úÖ Staff Profile model: ${staffProfiles.length} staff profiles found`);
    if (staffProfiles.length > 0) {
      console.log(`   - Sample staff: ${staffProfiles[0].full_name}`);
      console.log(`   - Has user_id: ${!!staffProfiles[0].user_id}`);
      console.log(`   - Has org_unit_id: ${!!staffProfiles[0].org_unit_id}`);
    }

    // Test Evidence model
    const evidences = await Evidence.find({}).limit(5);
    console.log(`‚úÖ Evidence model: ${evidences.length} evidences found`);
    if (evidences.length > 0) {
      console.log(`   - Sample evidence: ${evidences[0].title}`);
      console.log(`   - Has student_id: ${!!evidences[0].student_id}`);
      console.log(`   - Has self_point: ${evidences[0].self_point !== undefined}`);
    }

    // Test Attendance model
    const attendances = await Attendance.find({}).limit(5);
    console.log(`‚úÖ Attendance model: ${attendances.length} attendances found`);
    if (attendances.length > 0) {
      console.log(`   - Has student_id: ${!!attendances[0].student_id}`);
      console.log(`   - Has activity_id: ${!!attendances[0].activity_id}`);
    }

    console.log('‚úÖ T·∫•t c·∫£ models ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng\n');

  } catch (error) {
    console.error('‚ùå L·ªói ki·ªÉm tra models:', error.message);
    throw error;
  }
}

async function testRelationships() {
  console.log('üîó KI·ªÇM TRA RELATIONSHIPS...');
  
  try {
    // Test User -> UserRole -> Role relationship
    const userRoles = await UserRole.find({})
      .populate('user_id')
      .populate('role_id')
      .populate('org_unit_id')
      .limit(3);
    
    console.log(`‚úÖ UserRole relationships: ${userRoles.length} found`);
    if (userRoles.length > 0) {
      const ur = userRoles[0];
      console.log(`   - User: ${ur.user_id ? ur.user_id.username : 'N/A'}`);
      console.log(`   - Role: ${ur.role_id ? ur.role_id.name : 'N/A'}`);
      console.log(`   - Org Unit: ${ur.org_unit_id ? ur.org_unit_id.name : 'N/A'}`);
    }

    // Test Activity -> OrgUnit relationship
    const activitiesWithOrg = await Activity.find({})
      .populate('org_unit_id')
      .populate('field_id')
      .limit(3);
    
    console.log(`‚úÖ Activity relationships: ${activitiesWithOrg.length} found`);
    if (activitiesWithOrg.length > 0) {
      const activity = activitiesWithOrg[0];
      console.log(`   - Activity: ${activity.title}`);
      console.log(`   - Org Unit: ${activity.org_unit_id ? activity.org_unit_id.name : 'N/A'}`);
      console.log(`   - Field: ${activity.field_id ? activity.field_id.name : 'N/A'}`);
    }

    // Test Student Profile -> User relationship
    const studentProfiles = await StudentProfile.find({})
      .populate('user_id')
      .populate('class_id')
      .limit(3);
    
    console.log(`‚úÖ Student Profile relationships: ${studentProfiles.length} found`);
    if (studentProfiles.length > 0) {
      const sp = studentProfiles[0];
      console.log(`   - Student: ${sp.full_name}`);
      console.log(`   - User: ${sp.user_id ? sp.user_id.username : 'N/A'}`);
      console.log(`   - Class: ${sp.class_id ? sp.class_id.name : 'N/A'}`);
    }

    console.log('‚úÖ T·∫•t c·∫£ relationships ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng\n');

  } catch (error) {
    console.error('‚ùå L·ªói ki·ªÉm tra relationships:', error.message);
    throw error;
  }
}

async function testDataIntegrity() {
  console.log('üîí KI·ªÇM TRA DATA INTEGRITY...');
  
  try {
    // Check for orphaned records
    const orphanedUserRoles = await UserRole.find({ user_id: null });
    console.log(`‚úÖ Orphaned UserRoles: ${orphanedUserRoles.length}`);

    const orphanedActivities = await Activity.find({ org_unit_id: null });
    console.log(`‚úÖ Activities without OrgUnit: ${orphanedActivities.length}`);

    const orphanedEvidences = await Evidence.find({ student_id: null });
    console.log(`‚úÖ Evidences without Student: ${orphanedEvidences.length}`);

    // Check for duplicate records
    const duplicateUserRoles = await UserRole.aggregate([
      { $group: { _id: { user_id: '$user_id', role_id: '$role_id' }, count: { $sum: 1 } } },
      { $match: { count: { $gt: 1 } } }
    ]);
    console.log(`‚úÖ Duplicate UserRoles: ${duplicateUserRoles.length}`);

    // Check data consistency
    const usersWithoutProfiles = await User.find({}).then(async (users) => {
      let count = 0;
      for (const user of users) {
        const staffProfile = await StaffProfile.findOne({ user_id: user._id });
        const studentProfile = await StudentProfile.findOne({ user_id: user._id });
        if (!staffProfile && !studentProfile) count++;
      }
      return count;
    });
    console.log(`‚úÖ Users without profiles: ${usersWithoutProfiles}`);

    console.log('‚úÖ Data integrity check ho√†n t·∫•t\n');

  } catch (error) {
    console.error('‚ùå L·ªói ki·ªÉm tra data integrity:', error.message);
    throw error;
  }
}

async function testPermissions() {
  console.log('üîê KI·ªÇM TRA PERMISSION SYSTEM...');
  
  try {
    // Test Permission structure
    const permissions = await Permission.find({});
    console.log(`‚úÖ Total permissions: ${permissions.length}`);
    
    for (const permission of permissions) {
      console.log(`   - ${permission.name} (${permission.resource})`);
    }

    // Test Action model
    const actions = await Action.find({});
    console.log(`‚úÖ Total actions: ${actions.length}`);

    // Test RoleAction relationships
    const roleActions = await RoleAction.find({})
      .populate('role_id')
      .populate('action_id')
      .limit(5);
    
    console.log(`‚úÖ RoleAction relationships: ${roleActions.length} found`);
    if (roleActions.length > 0) {
      const ra = roleActions[0];
      console.log(`   - Role: ${ra.role_id ? ra.role_id.name : 'N/A'}`);
      console.log(`   - Action: ${ra.action_id ? ra.action_id.action_name : 'N/A'}`);
    }

    console.log('‚úÖ Permission system ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng\n');

  } catch (error) {
    console.error('‚ùå L·ªói ki·ªÉm tra permission system:', error.message);
    throw error;
  }
}

async function generateReport() {
  console.log('üìä B√ÅO C√ÅO T·ªîNG QUAN...');
  
  try {
    const counts = {
      users: await User.countDocuments(),
      roles: await Role.countDocuments(),
      permissions: await Permission.countDocuments(),
      actions: await Action.countDocuments(),
      roleActions: await RoleAction.countDocuments(),
      userRoles: await UserRole.countDocuments(),
      userActionOverrides: await UserActionOverride.countDocuments(),
      fields: await Field.countDocuments(),
      falcuties: await Falcuty.countDocuments(),
      cohorts: await Cohort.countDocuments(),
      classes: await Class.countDocuments(),
      orgUnits: await OrgUnit.countDocuments(),
      staffProfiles: await StaffProfile.countDocuments(),
      studentProfiles: await StudentProfile.countDocuments(),
      activities: await Activity.countDocuments(),
      activityRegistrations: await ActivityRegistration.countDocuments(),
      activityEligibilities: await ActivityEligibility.countDocuments(),
      attendances: await Attendance.countDocuments(),
      evidences: await Evidence.countDocuments(),
      studentFeedbacks: await StudentFeedback.countDocuments(),
      studentCohorts: await StudentCohort.countDocuments(),
      pvcdRecords: await PVCDRecord.countDocuments(),
      posts: await Post.countDocuments()
    };
    
    console.log('='.repeat(70));
    console.log('üìä B√ÅO C√ÅO T·ªîNG QUAN H·ªÜ TH·ªêNG');
    console.log('='.repeat(70));
    console.log(`üë• Users: ${counts.users}`);
    console.log(`üé≠ Roles: ${counts.roles}`);
    console.log(`üîê Permissions: ${counts.permissions}`);
    console.log(`‚ö° Actions: ${counts.actions}`);
    console.log(`üîó Role Actions: ${counts.roleActions}`);
    console.log(`üë§ User Roles: ${counts.userRoles}`);
    console.log(`üîß User Action Overrides: ${counts.userActionOverrides}`);
    console.log(`üìÇ Fields: ${counts.fields}`);
    console.log(`üè´ Falcuties: ${counts.falcuties}`);
    console.log(`üìÖ Cohorts: ${counts.cohorts}`);
    console.log(`üéì Classes: ${counts.classes}`);
    console.log(`üè¢ Org Units: ${counts.orgUnits}`);
    console.log(`üë®‚Äçüíº Staff Profiles: ${counts.staffProfiles}`);
    console.log(`üë®‚Äçüéì Student Profiles: ${counts.studentProfiles}`);
    console.log(`üéØ Activities: ${counts.activities}`);
    console.log(`üìù Activity Registrations: ${counts.activityRegistrations}`);
    console.log(`‚úÖ Activity Eligibilities: ${counts.activityEligibilities}`);
    console.log(`üìã Attendances: ${counts.attendances}`);
    console.log(`üìÑ Evidences: ${counts.evidences}`);
    console.log(`üí¨ Student Feedbacks: ${counts.studentFeedbacks}`);
    console.log(`üéì Student Cohorts: ${counts.studentCohorts}`);
    console.log(`üìä PVCD Records: ${counts.pvcdRecords}`);
    console.log(`üì∞ Posts: ${counts.posts}`);
    console.log('='.repeat(70));
    
    const totalRecords = Object.values(counts).reduce((sum, count) => sum + count, 0);
    console.log(`\nüéØ T·ªîNG C·ªòNG: ${totalRecords} records`);
    
    console.log('\n‚úÖ H·ªÜ TH·ªêNG HO·∫†T ƒê·ªòNG B√åNH TH∆Ø·ªúNG!');
    console.log('üöÄ S·∫µn s√†ng ƒë·ªÉ s·ª≠ d·ª•ng!\n');

  } catch (error) {
    console.error('‚ùå L·ªói t·∫°o b√°o c√°o:', error.message);
    throw error;
  }
}

// Main function
async function main() {
  try {
    await connectDB();
    
    await testModels();
    await testRelationships();
    await testDataIntegrity();
    await testPermissions();
    await generateReport();
    
    console.log('üéâ TEST HO√ÄN T·∫§T!\n');
    
  } catch (error) {
    console.error('\n‚ùå L·ªñI:', error);
    process.exit(1);
  } finally {
    await mongoose.connection.close();
    console.log('üëã ƒê√£ ƒë√≥ng k·∫øt n·ªëi MongoDB\n');
  }
}

main();
