<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Manager - PHASE 2.5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        button:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .qr-display {
            text-align: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .qr-display img {
            max-width: 300px;
            height: auto;
            margin-bottom: 15px;
        }

        .qr-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .qr-info p {
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        .qr-history {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .qr-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .qr-item.active {
            border: 2px solid #10b981;
            background: #f0fdf4;
        }

        .qr-item.expired {
            border: 2px solid #ef4444;
            background: #fef2f2;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-expired {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
            display: block;
        }

        .message.info {
            background: #dbeafe;
            color: #0c4a6e;
            border: 1px solid #bfdbfe;
            display: block;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± QR Code Manager</h1>
            <p>PHASE 2.5: On-Demand QR Generation</p>
        </div>

        <!-- Auth Card -->
        <div class="card" id="authCard">
            <h2>Authentication</h2>
            <div class="form-group">
                <label>Token (Paste from frontend)</label>
                <input type="password" id="token" placeholder="eyJhbGc...">
            </div>
            <button class="btn-primary" onclick="authenticate()">Login</button>
            <button class="btn-success" onclick="loadFromLocalStorage()" style="margin-left: 10px;">Use Saved Token</button>
            <div id="authMessage" class="message" style="margin-top: 15px;"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <!-- Activity Selection -->
            <div class="card">
                <h2>Select Activity</h2>
                <div class="form-group">
                    <label>Activity</label>
                    <select id="activitySelect" onchange="loadActivity()">
                        <option value="">-- Choose Activity --</option>
                    </select>
                </div>
                <div id="activityMessage" class="message"></div>
            </div>

            <!-- Current QR Display -->
            <div class="card" id="currentQRCard" style="display: none;">
                <h2>‚úÖ Current QR (Active)</h2>
                
                <div class="qr-display" id="currentQRDisplay">
                    <img id="currentQRImage" src="" alt="Current QR">
                    <div class="qr-info">
                        <p><strong>Name:</strong> <span id="currentQRName">-</span></p>
                        <p><strong>Created:</strong> <span id="currentQRCreated">-</span></p>
                        <p><strong>Expires:</strong> <span id="currentQRExpires">-</span></p>
                        <p><strong>Scans:</strong> <span id="currentQRScans">0</span></p>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="copyQRData()">üìã Copy Data</button>
                    <button class="btn-success" onclick="printQR()">üñ®Ô∏è Print QR</button>
                </div>
            </div>

            <!-- Generate New QR -->
            <div class="card">
                <h2>Generate New QR</h2>
                
                <div class="form-group">
                    <label>QR Name (e.g., "Bu·ªïi S√°ng", "Round 1")</label>
                    <input type="text" id="qrName" placeholder="ƒêi·ªÉm danh Bu·ªïi S√°ng">
                </div>

                <div class="form-group">
                     <label>Duration (Minutes) - Leave blank for no expiry</label>
                     <input type="number" id="duration" placeholder="60" min="1">
                 </div>

                 <!-- üÜï GEOFENCE: Radius Input -->
                 <div class="form-group">
                     <label>Geofence Radius (Meters) - Distance for location check (Optional)</label>
                     <input type="number" id="geofenceRadius" placeholder="80" min="1" value="">
                     <small style="color: #666; display: block; margin-top: 5px;">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën gi·ªõi h·∫°n kho·∫£ng c√°ch. N·∫øu c√≥, ph·∫£i l√† s·ªë d∆∞∆°ng.</small>
                 </div>

                 <!-- üÜï GEOFENCE: Accuracy Mode Option -->
                 <div class="form-group" style="background: #f9fafb; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                     <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                         <input type="checkbox" id="highAccuracyMode" style="width: auto; cursor: pointer;">
                         <span>üéØ Ch·∫ø ƒë·ªô ch√≠nh x√°c cao (c√≥ th·ªÉ ch·∫≠m h∆°n, d·ªÖ timeout)</span>
                     </label>
                     <small style="color: #666; display: block; margin-top: 5px;">B·ªè ch·ªçn ƒë·ªÉ l·∫•y v·ªã tr√≠ nhanh h∆°n (khuy·∫øn ngh·ªã)</small>
                 </div>

                 <!-- üÜï GEOFENCE: Location Info Display -->
                 <div class="form-group" id="locationInfo" style="background: #f0fdf4; padding: 10px; border-radius: 6px; border: 1px solid #86efac;">
                     <label style="color: #166534; font-weight: 600;">üìç V·ªã tr√≠ T·∫°o QR</label>
                     <p id="locationStatus" style="margin: 5px 0; color: #666; font-size: 0.9em;">Ch∆∞a l·∫•y v·ªã tr√≠</p>
                     <p id="locationCoords" style="margin: 5px 0; color: #666; font-size: 0.85em; font-family: monospace;"></p>
                     <div id="accuracyTips" style="margin-top: 10px; font-size: 0.85em; color: #666; display: none;">
                         <strong>üí° M·∫πo c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c:</strong>
                         <ul style="margin: 5px 0 0 20px; padding: 0;">
                             <li>Di chuy·ªÉn ra ngo√†i tr·ªùi (tr√°nh trong nh√†)</li>
                             <li>B·∫≠t GPS tr√™n thi·∫øt b·ªã</li>
                             <li>ƒê·ª£i v√†i gi√¢y ƒë·ªÉ GPS ·ªïn ƒë·ªãnh</li>
                             <li>Tr√°nh khu v·ª±c c√≥ nhi·ªÅu t√≤a nh√† cao</li>
                         </ul>
                     </div>
                 </div>

                 <div class="button-group">
                     <button type="button" class="btn-success" onclick="captureLocationForQR()">üìç L·∫•y GPS Hi·ªán T·∫°i</button>
                     <button type="button" id="retryLocationBtn" class="btn-success" onclick="captureLocationForQR()" style="display: none;">üîÑ Th·ª≠ L·∫°i (C·∫£i Thi·ªán ƒê·ªô Ch√≠nh X√°c)</button>
                     <button type="button" class="btn-primary" onclick="generateNewQR()">üéØ T·∫°o QR t·∫°i v·ªã tr√≠ n√†y</button>
                 </div>
                 <div id="generateMessage" class="message" style="margin-top: 15px;"></div>
            </div>

            <!-- QR History -->
            <div class="card" id="historyCard" style="display: none;">
                <h2>üìú QR History</h2>
                <div id="qrHistoryList" class="qr-history"></div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-danger" onclick="deleteOldQRs()">üóëÔ∏è Delete Old QRs (Keep Latest 3)</button>
                </div>
                <div id="historyMessage" class="message" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        // üÜï GEOFENCE: Store captured location and radius
        let capturedLocation = null;
        let capturedGeofenceRadius = null;

        // ===== TOKEN MANAGEMENT =====
        function getToken() {
            return document.getElementById('token').value.trim() || localStorage.getItem('qrManagerToken');
        }

        function saveToken(token) {
            const cleanToken = token.replace(/^Bearer\s+/i, '').trim();
            localStorage.setItem('qrManagerToken', cleanToken);
            document.getElementById('token').value = cleanToken;
            console.log('Token saved');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('qrManagerToken');
            if (saved) {
                document.getElementById('token').value = saved;
                authenticate();
            } else {
                showMessage('authMessage', 'No saved token found', 'error');
            }
        }

        // ===== AUTHENTICATION =====
        async function authenticate() {
            const token = getToken();
            if (!token) {
                showMessage('authMessage', 'Please enter token', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/attendances`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Authentication failed');

                saveToken(token);
                showMessage('authMessage', '‚úÖ Authenticated!', 'success');
                
                document.getElementById('authCard').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                loadActivities();
            } catch (err) {
                showMessage('authMessage', `‚ùå ${err.message}`, 'error');
            }
        }

        // ===== LOAD ACTIVITIES =====
        async function loadActivities() {
            try {
                const token = getToken();
                const res = await fetch(`${API_BASE}/activities`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load activities');

                const data = await res.json();
                const activities = data.data || [];

                const select = document.getElementById('activitySelect');
                select.innerHTML = '<option value="">-- Choose Activity --</option>';
                activities.forEach(act => {
                    select.innerHTML += `<option value="${act._id}">${act.title}</option>`;
                });
            } catch (err) {
                console.error('Error loading activities:', err);
            }
        }

        // ===== LOAD ACTIVITY QRs =====
        async function loadActivity() {
            const activityId = document.getElementById('activitySelect').value;
            if (!activityId) {
                document.getElementById('currentQRCard').style.display = 'none';
                document.getElementById('historyCard').style.display = 'none';
                return;
            }

            try {
                const token = getToken();
                const res = await fetch(`${API_BASE}/attendances/activity/${activityId}/qr-codes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load QRs');

                const data = await res.json();
                displayQRs(data.data);
            } catch (err) {
                showMessage('activityMessage', `‚ùå ${err.message}`, 'error');
            }
        }

        // ===== DISPLAY QRs =====
        function displayQRs(data) {
            if (!data) return;

            // Display current QR
            if (data.current) {
                const current = data.current;
                document.getElementById('currentQRImage').src = current.qr_code;
                document.getElementById('currentQRName').textContent = current.qr_name || 'N/A';
                document.getElementById('currentQRCreated').textContent = new Date(current.created_at).toLocaleString('vi-VN');
                document.getElementById('currentQRExpires').textContent = current.expires_at 
                    ? new Date(current.expires_at).toLocaleString('vi-VN')
                    : 'No Expiration';
                document.getElementById('currentQRScans').textContent = current.scans_count;
                document.getElementById('currentQRCard').style.display = 'block';
            } else {
                document.getElementById('currentQRCard').style.display = 'none';
            }

            // Display history
            if (data.history && data.history.length > 0) {
                const historyHTML = data.history.map(qr => `
                    <div class="qr-item ${qr.is_active ? 'active' : 'expired'}">
                        <p><strong>${qr.qr_name}</strong></p>
                        <p style="font-size: 0.8em; color: #666;">
                            ${new Date(qr.created_at).toLocaleString('vi-VN')}
                        </p>
                        <p style="font-size: 0.8em;">Scans: ${qr.scans_count}</p>
                        <span class="status-badge ${qr.is_active ? 'status-active' : 'status-expired'}">
                            ${qr.status === 'active' ? '‚úÖ Active' : '‚è∞ Expired'}
                        </span>
                    </div>
                `).join('');
                document.getElementById('qrHistoryList').innerHTML = historyHTML;
                document.getElementById('historyCard').style.display = 'block';
            } else {
                document.getElementById('historyCard').style.display = 'none';
            }
        }

        // üÜï GEOFENCE: Capture location for QR creation
        async function captureLocationForQR() {
             console.log('üìç captureLocationForQR() called');
             
             try {
                 // Disable buttons and show loading
                 const buttons = document.querySelectorAll('.button-group button');
                 const getLocationBtn = Array.from(buttons).find(btn => btn.textContent.includes('L·∫•y GPS'));
                 const retryBtn = document.getElementById('retryLocationBtn');
                 const generateBtn = Array.from(buttons).find(btn => btn.textContent.includes('T·∫°o QR'));
                 
                 if (getLocationBtn) getLocationBtn.disabled = true;
                 if (retryBtn) retryBtn.disabled = true;
                 if (generateBtn) generateBtn.disabled = true;
                 
                 const statusEl = document.getElementById('locationStatus');
                 const infoEl = document.getElementById('locationInfo');
                 
                 if (statusEl) {
                     statusEl.textContent = '‚è≥ ƒêang l·∫•y v·ªã tr√≠... (Vui l√≤ng ƒë·ª£i, c√≥ th·ªÉ m·∫•t 10-20 gi√¢y)';
                     statusEl.style.color = '#3b82f6';
                 }
                 if (infoEl) {
                     infoEl.style.background = '#eff6ff';
                     infoEl.style.borderColor = '#93c5fd';
                 }
                 showMessage('generateMessage', '‚è≥ ƒêang l·∫•y v·ªã tr√≠ GPS... Vui l√≤ng ƒë·ª£i v√† ƒë·∫£m b·∫£o b·∫°n ƒë√£ cho ph√©p truy c·∫≠p v·ªã tr√≠.', 'info');
             
                 // Ki·ªÉm tra xem geolocation c√≥ available kh√¥ng
                 console.log('üîç Checking navigator.geolocation:', typeof navigator.geolocation);
                 if (!navigator.geolocation) {
                     console.error('‚ùå navigator.geolocation is not available');
                     throw new Error('Geolocation kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát n√†y');
                 }
                 
                 // Ki·ªÉm tra protocol (HTTPS required for some browsers)
                 const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                 console.log('üîí Protocol check:', {
                     protocol: window.location.protocol,
                     hostname: window.location.hostname,
                     isSecure: isSecure
                 });
                 
                 if (!isSecure && window.location.protocol !== 'http:') {
                     console.warn('‚ö†Ô∏è Geolocation may require HTTPS in some browsers');
                 }
                 
                 // Ki·ªÉm tra user c√≥ ch·ªçn high accuracy mode kh√¥ng
                 const highAccuracyMode = document.getElementById('highAccuracyMode').checked;
                 console.log('üéØ High accuracy mode:', highAccuracyMode);
                 
                 // C·∫•u h√¨nh d·ª±a tr√™n mode
                 const geoOptions = highAccuracyMode 
                     ? {
                         enableHighAccuracy: true,
                         timeout: 15000, // 15 gi√¢y cho high accuracy
                         maximumAge: 60000 // Cache 1 ph√∫t
                     }
                     : {
                         enableHighAccuracy: false, // Normal accuracy - nhanh h∆°n, √≠t timeout
                         timeout: 10000, // TƒÉng t·ª´ 8s l√™n 10s ƒë·ªÉ tr√°nh timeout qu√° nhanh
                         maximumAge: 600000 // Cho ph√©p d√πng cache trong 10 ph√∫t (nhanh h∆°n nhi·ªÅu)
                     };
                 
                 console.log('‚öôÔ∏è Geolocation options:', geoOptions);
                 console.log('‚è≥ Requesting GPS position...');
                 
                 const position = await new Promise((resolve, reject) => {
                     const startTime = Date.now();
                     
                     navigator.geolocation.getCurrentPosition(
                         (pos) => {
                             const elapsed = Date.now() - startTime;
                             console.log(`‚úÖ GPS position received (took ${elapsed}ms):`, {
                                 latitude: pos.coords.latitude,
                                 longitude: pos.coords.longitude,
                                 accuracy: pos.coords.accuracy
                             });
                             resolve(pos);
                         },
                         (err) => {
                             const elapsed = Date.now() - startTime;
                             console.error(`‚ùå GPS error (took ${elapsed}ms):`, {
                                 code: err.code,
                                 message: err.message,
                                 PERMISSION_DENIED: err.PERMISSION_DENIED,
                                 POSITION_UNAVAILABLE: err.POSITION_UNAVAILABLE,
                                 TIMEOUT: err.TIMEOUT
                             });
                             reject(err);
                         },
                         geoOptions
                     );
                 });

                 capturedLocation = {
                     latitude: position.coords.latitude,
                     longitude: position.coords.longitude,
                     accuracy: position.coords.accuracy
                 };
                 
                 console.log('‚úÖ Location captured and stored:', capturedLocation);

                 const accuracyMeters = Math.round(capturedLocation.accuracy);
                 
                 // Update UI based on accuracy
                 if (accuracyMeters > 200) {
                     // Low accuracy warning
                     document.getElementById('locationStatus').textContent = `‚ö†Ô∏è ƒê·ªô ch√≠nh x√°c TH·∫§P: ¬±${accuracyMeters}m (Khuy·∫øn ngh·ªã: <50m)`;
                     document.getElementById('locationStatus').style.color = '#f59e0b';
                     document.getElementById('locationInfo').style.background = '#fffbeb';
                     document.getElementById('locationInfo').style.borderColor = '#fcd34d';
                     document.getElementById('accuracyTips').style.display = 'block';
                     document.getElementById('retryLocationBtn').style.display = 'inline-block';
                     showMessage('generateMessage', `‚ö†Ô∏è C·∫£nh b√°o: ƒê·ªô ch√≠nh x√°c ¬±${accuracyMeters}m r·∫•t th·∫•p! Geofence c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông t·ªët. Khuy·∫øn ngh·ªã: Di chuy·ªÉn ra ngo√†i tr·ªùi, b·∫≠t GPS, ho·∫∑c th·ª≠ l·∫°i.`, 'error');
                 } else if (accuracyMeters > 50) {
                     // Medium accuracy
                     document.getElementById('locationStatus').textContent = `‚ö†Ô∏è ƒê·ªô ch√≠nh x√°c TRUNG B√åNH: ¬±${accuracyMeters}m (Khuy·∫øn ngh·ªã: <50m)`;
                     document.getElementById('locationStatus').style.color = '#f59e0b';
                     document.getElementById('locationInfo').style.background = '#fffbeb';
                     document.getElementById('locationInfo').style.borderColor = '#fcd34d';
                     document.getElementById('accuracyTips').style.display = 'block';
                     document.getElementById('retryLocationBtn').style.display = 'inline-block';
                     showMessage('generateMessage', `‚ö†Ô∏è ƒê·ªô ch√≠nh x√°c ¬±${accuracyMeters}m ·ªü m·ª©c trung b√¨nh. ƒê·ªÉ geofence ho·∫°t ƒë·ªông t·ªët h∆°n, h√£y di chuy·ªÉn ra ngo√†i tr·ªùi ho·∫∑c b·∫≠t GPS.`, 'error');
                 } else {
                     // Good accuracy
                     document.getElementById('locationStatus').textContent = `‚úÖ ƒê√£ l·∫•y v·ªã tr√≠ (ƒë·ªô ch√≠nh x√°c: ¬±${accuracyMeters}m)`;
                     document.getElementById('locationStatus').style.color = '#166534';
                     document.getElementById('locationInfo').style.background = '#f0fdf4';
                     document.getElementById('locationInfo').style.borderColor = '#86efac';
                     document.getElementById('accuracyTips').style.display = 'none';
                     document.getElementById('retryLocationBtn').style.display = 'none';
                     showMessage('generateMessage', '‚úÖ ƒê√£ l·∫•y v·ªã tr√≠ th√†nh c√¥ng! B√¢y gi·ªù b·∫•m "üéØ T·∫°o QR t·∫°i v·ªã tr√≠ n√†y"', 'success');
                 }
                 
                 document.getElementById('locationCoords').textContent = `Lat: ${capturedLocation.latitude.toFixed(6)}, Lng: ${capturedLocation.longitude.toFixed(6)}`;
                 
                 // Re-enable buttons
                 if (getLocationBtn) getLocationBtn.disabled = false;
                 if (retryBtn) retryBtn.disabled = false;
                 if (generateBtn) generateBtn.disabled = false;
             } catch (error) {
                 // Re-enable buttons on error
                 if (getLocationBtn) getLocationBtn.disabled = false;
                 if (retryBtn) retryBtn.disabled = false;
                 if (generateBtn) generateBtn.disabled = false;
                 
                 // Log error for debugging
                 console.error('‚ùå GPS Error caught:', {
                     code: error.code,
                     message: error.message,
                     name: error.name,
                     stack: error.stack
                 });
                 
                 // Error codes: 1 = PERMISSION_DENIED, 2 = POSITION_UNAVAILABLE, 3 = TIMEOUT
                 // Use constants from GeolocationPositionError if available
                 const PERMISSION_DENIED = 1;
                 const POSITION_UNAVAILABLE = 2;
                 const TIMEOUT = 3;
                 
                 if (error.code === PERMISSION_DENIED || error.code === 1) {
                     console.error('‚ùå Error Code 1: PERMISSION_DENIED - User denied location access');
                     showMessage('generateMessage', '‚ùå User denied Geolocation. Vui l√≤ng b·∫≠t quy·ªÅn truy c·∫≠p v·ªã tr√≠ trong tr√¨nh duy·ªát v√† th·ª≠ l·∫°i.', 'error');
                     const statusEl = document.getElementById('locationStatus');
                     const infoEl = document.getElementById('locationInfo');
                     if (statusEl) {
                         statusEl.textContent = '‚ùå B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠';
                         statusEl.style.color = '#dc2626';
                     }
                     if (infoEl) {
                         infoEl.style.background = '#fef2f2';
                         infoEl.style.borderColor = '#fca5a5';
                     }
                 } else if (error.code === POSITION_UNAVAILABLE || error.code === 2) {
                     console.error('‚ùå Error Code 2: POSITION_UNAVAILABLE - GPS not available');
                     showMessage('generateMessage', '‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng ki·ªÉm tra GPS/Internet v√† th·ª≠ l·∫°i.', 'error');
                     const statusEl = document.getElementById('locationStatus');
                     if (statusEl) {
                         statusEl.textContent = '‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠';
                         statusEl.style.color = '#dc2626';
                     }
                 } else if (error.code === TIMEOUT || error.code === 3) {
                     console.error('‚ùå Error Code 3: TIMEOUT - Request took too long');
                     showMessage('generateMessage', '‚ùå Timeout l·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i (c√≥ th·ªÉ c·∫ßn di chuy·ªÉn ra ngo√†i tr·ªùi)', 'error');
                     const statusEl = document.getElementById('locationStatus');
                     if (statusEl) {
                         statusEl.textContent = '‚ùå Timeout - Vui l√≤ng th·ª≠ l·∫°i';
                         statusEl.style.color = '#dc2626';
                     }
                 } else {
                     // Handle other errors (including "Geolocation kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£")
                     const errorMsg = error.message || 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠';
                     console.error('‚ùå Unknown error:', errorMsg);
                     showMessage('generateMessage', `‚ùå L·ªói: ${errorMsg}`, 'error');
                     const statusEl = document.getElementById('locationStatus');
                     const infoEl = document.getElementById('locationInfo');
                     if (statusEl) {
                         statusEl.textContent = `‚ùå ${errorMsg}`;
                         statusEl.style.color = '#dc2626';
                     }
                     if (infoEl) {
                         infoEl.style.background = '#fef2f2';
                         infoEl.style.borderColor = '#fca5a5';
                     }
                 }
                 
                 // Show retry button and tips
                 const tipsEl = document.getElementById('accuracyTips');
                 const retryEl = document.getElementById('retryLocationBtn');
                 if (tipsEl) tipsEl.style.display = 'block';
                 if (retryEl) retryEl.style.display = 'inline-block';
             }
         }

        // ===== GENERATE NEW QR =====
        /**
         * üìã THAM S·ªê C·∫¶N G·ª¨I T·ª™ FRONTEND (POST /api/attendances/generate-qr):
         * 
         * Request Body:
         * {
         *   activity_id: string (REQUIRED) 
         *   qr_name: string (OPTIONAL) 
         *   duration_minutes: number (OPTIONAL) 
         *   location: { (REQUIRED OBJECT)
         *     latitude: number (REQUIRED) 
         *     longitude: number (REQUIRED) 
         *     accuracy: number (OPTIONAL) 
         *     geofence_radius_m: number (REQUIRED) 
         *   }
         * }
         * 
         * Headers:
         * - Authorization: Bearer <token> (REQUIRED)
         * - Content-Type: application/json
         * 
         * Response:
         * {
         *   success: boolean,
         *   message: string,
         *   data: {
         *     qr_id: string,
         *     qr_name: string,
         *     qr_code: string (Base64 image),
         *     created_at: Date,
         *     expires_at: Date | null,
         *     scans_count: number,
         *     location: { latitude, longitude, accuracy_m },
         *     geofence_radius_m: number,
         *     total_qr_created: number
         *   }
         * }
         */
        async function generateNewQR() {
            const activityId = document.getElementById('activitySelect').value;
            if (!activityId) {
                showMessage('generateMessage', 'Please select activity first', 'error');
                return;
            }

            // üÜï GEOFENCE: Check if location is captured
            if (!capturedLocation) {
                showMessage('generateMessage', '‚ùå Vui l√≤ng b·∫•m "üìç L·∫•y GPS Hi·ªán T·∫°i" tr∆∞·ªõc', 'error');
                return;
            }

            // üÜï GEOFENCE: Get radius from input (optional)
            const radiusInput = document.getElementById('geofenceRadius').value.trim();
            
            // N·∫øu c√≥ ƒëi·ªÅn radius ‚Üí validate ph·∫£i l√† s·ªë d∆∞∆°ng
            if (radiusInput && (isNaN(radiusInput) || parseFloat(radiusInput) <= 0)) {
                showMessage('generateMessage', '‚ùå Geofence radius ph·∫£i l√† s·ªë d∆∞∆°ng', 'error');
                return;
            }

            const qrName = document.getElementById('qrName').value.trim();
            const duration = document.getElementById('duration').value;
            const geofenceRadius = radiusInput ? parseFloat(radiusInput) : null;

            try {
                const token = getToken();
                const res = await fetch(`${API_BASE}/attendances/generate-qr`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        activity_id: activityId,
                        qr_name: qrName || `QR #${new Date().toLocaleTimeString()}`,
                        duration_minutes: duration ? parseInt(duration) : null,
                        // üÜï GEOFENCE: Send location with radius
                        location: {
                            ...capturedLocation,
                            geofence_radius_m: geofenceRadius
                        }
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Failed to generate QR');
                }

                showMessage('generateMessage', '‚úÖ QR Generated!', 'success');
                document.getElementById('qrName').value = '';
                document.getElementById('duration').value = '';
                document.getElementById('geofenceRadius').value = '';
                capturedLocation = null;
                document.getElementById('locationStatus').textContent = 'Ch∆∞a l·∫•y v·ªã tr√≠';
                document.getElementById('locationStatus').style.color = '#666';
                document.getElementById('locationCoords').textContent = '';
                document.getElementById('accuracyTips').style.display = 'none';
                document.getElementById('retryLocationBtn').style.display = 'none';
                
                setTimeout(() => loadActivity(), 1000);
            } catch (err) {
                showMessage('generateMessage', `‚ùå ${err.message}`, 'error');
            }
        }

        // ===== COPY QR DATA =====
        function copyQRData() {
            const img = document.getElementById('currentQRImage').src;
            navigator.clipboard.writeText(img);
            showMessage('currentQRDisplay', '‚úÖ QR copied to clipboard!', 'info');
        }

        // ===== PRINT QR =====
        function printQR() {
            const printWindow = window.open();
            printWindow.document.write('<img src="' + document.getElementById('currentQRImage').src + '" style="width: 400px;">');
            printWindow.print();
        }

        // ===== DELETE OLD QRs =====
        async function deleteOldQRs() {
            const activityId = document.getElementById('activitySelect').value;
            if (!activityId) {
                showMessage('historyMessage', 'Please select activity first', 'error');
                return;
            }

            if (!confirm('Delete old QRs? (Keep latest 3)')) return;

            try {
                const token = getToken();
                const res = await fetch(`${API_BASE}/attendances/activity/${activityId}/qr-codes?keep_latest=3`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to delete');

                showMessage('historyMessage', '‚úÖ Old QRs deleted!', 'success');
                setTimeout(() => loadActivity(), 1000);
            } catch (err) {
                showMessage('historyMessage', `‚ùå ${err.message}`, 'error');
            }
        }

        // ===== UTILITIES =====
        function showMessage(elementId, msg, type) {
            const el = document.getElementById(elementId);
            if (el.classList) {
                el.classList.remove('success', 'error', 'info');
                el.classList.add(type);
            }
            el.innerHTML = msg;
            if (type === 'success') {
                setTimeout(() => el.innerHTML = '', 3000);
            }
        }

        // üÜï Request GPS location on page load
        async function requestGPSOnPageLoad(retryCount = 0) {
            const MAX_RETRIES = 3;
            console.log(`üîç Requesting GPS location on qr-manager... (Attempt ${retryCount + 1}/${MAX_RETRIES + 1})`);
            
            if (!navigator.geolocation) {
                console.warn('‚ö†Ô∏è Geolocation not supported');
                return;
            }
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: false,
                            timeout: 10000,
                            maximumAge: 0  // Lu√¥n l·∫•y v·ªã tr√≠ m·ªõi (kh√¥ng cache)
                        }
                    );
                });
                
                console.log('‚úÖ GPS Location obtained on page load:', {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: Math.round(position.coords.accuracy)
                });
            } catch (error) {
                console.error(`‚ùå GPS Error (Attempt ${retryCount + 1}):`, error.code, error.message);
                
                // Auto-retry cho timeout ho·∫∑c unavailable
                if ((error.code === 2 || error.code === 3) && retryCount < MAX_RETRIES) {
                    console.log(`‚è≥ Retrying GPS in 2 seconds...`);
                    setTimeout(() => requestGPSOnPageLoad(retryCount + 1), 2000);
                } else if (error.code === 1) {
                    console.warn('‚ö†Ô∏è User denied GPS permission. Will ask again when generating QR.');
                }
            }
        }

        // Auto-load if token saved
        window.addEventListener('load', () => {
            // üÜï Request GPS on page load (non-blocking)
            requestGPSOnPageLoad();
            
            if (localStorage.getItem('qrManagerToken')) {
                loadFromLocalStorage();
            }
        });
    </script>
</body>
</html>
