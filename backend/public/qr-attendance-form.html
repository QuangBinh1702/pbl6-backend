<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒêi·ªÉm Danh Ho·∫°t ƒê·ªông</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --error: #ef4444;
            --success: #10b981;
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-main);
        }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 480px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--text-muted);
        }

        .status-card {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .status-card.loading {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1e40af;
        }

        .status-card.success {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #047857;
        }

        .status-card.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #b91c1c;
        }

        .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        input,
        select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: #fff;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #9ca3af;
        }

        .btn-retry {
            background: white;
            color: var(--text-main);
            border: 1px solid #e5e7eb;
            margin-top: 10px;
            padding: 10px;
            font-size: 14px;
        }

        .helper-text {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .info-box {
            background: linear-gradient(to right, #e0e7ff, #fae8ff);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-size: 13px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .spinner-blue {
            border-color: #cbd5e1;
            border-top-color: var(--primary);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Modal/Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.show {
            opacity: 1;
        }

        /* Distance Indicator */
        .distance-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .distance-bad {
            color: var(--error);
        }

        .distance-good {
            color: var(--success);
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>üìã ƒêi·ªÉm Danh</h1>
            <p>X√°c th·ª±c v·ªã tr√≠ v√† th√¥ng tin sinh vi√™n</p>
        </div>

        <!-- GPS Status Section -->
        <div id="gpsStatusCard" class="status-card loading">
            <div class="status-icon">üìç</div>
            <div style="flex: 1;">
                <div id="gpsStatusTitle" style="font-weight: 600; font-size: 14px;">ƒêang t√¨m v·ªã tr√≠...</div>
                <div id="gpsStatusDesc" style="font-size: 12px; margin-top: 2px;">Vui l√≤ng cho ph√©p truy c·∫≠p GPS</div>
                <div id="distanceInfo" class="distance-indicator" style="display: none;">
                    üéØ C√°ch ƒëi·ªÉm danh: <span id="distVal">--</span>m
                </div>
            </div>
            <div id="gpsSpinner" class="spinner spinner-blue"></div>
        </div>

        <button type="button" id="retryGpsBtn" class="btn btn-retry" style="display: none; margin-bottom: 20px;">
            üîÑ Th·ª≠ l·∫°i GPS
        </button>

        <!-- Activity Info (Hidden by default, shown after QR load) -->
        <div id="activityInfo" class="info-box" style="display: none;">
            <div class="info-row">
                <span>Ho·∫°t ƒë·ªông:</span>
                <strong id="actTitle">--</strong>
            </div>
            <div class="info-row">
                <span>ƒêi·ªÉm t·ªëi ƒëa:</span>
                <strong id="actPoints">--</strong>
            </div>
        </div>

        <form id="attendanceForm">
            <input type="hidden" id="activity_id">
            <input type="hidden" id="session_id">

            <div class="form-group">
                <label>T√™n sinh vi√™n <span style="color:red">*</span></label>
                <input type="text" id="student_name" placeholder="Nguy·ªÖn VƒÉn A" required>
            </div>

            <div class="form-group">
                <label>M√£ s·ªë sinh vi√™n (MSSV) <span style="color:red">*</span></label>
                <input type="tel" id="student_id" placeholder="102xxxxxx" maxlength="9" required>
                <div class="helper-text">Nh·∫≠p ch√≠nh x√°c 9 ch·ªØ s·ªë MSSV</div>
            </div>

            <div class="form-group">
                <label>Khoa <span style="color:red">*</span></label>
                <select id="faculty" required>
                    <option value="">-- Ch·ªçn khoa --</option>
                </select>
            </div>

            <div class="form-group">
                <label>L·ªõp <span style="color:red">*</span></label>
                <select id="class" disabled required>
                    <option value="">-- Ch·ªçn l·ªõp --</option>
                </select>
            </div>

            <button type="submit" id="submitBtn" class="btn">
                <span>N·ªôp ƒêi·ªÉm Danh</span>
            </button>
        </form>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Th√¥ng b√°o</div>

    <script>
        const API_BASE_URL = 'https://pbl6-backend-iy5q.onrender.com/api';

        // State
        let state = {
            currentLocation: null,   // { latitude, longitude, accuracy }
            targetLocation: null,    // { latitude, longitude } (from QR)
            geofenceRadius: null,    // meters (from QR)
            isLocationValid: false,
            distance: null,
            qrCodeId: null
        };

        // DOM Elements
        const els = {
            gpsCard: document.getElementById('gpsStatusCard'),
            gpsTitle: document.getElementById('gpsStatusTitle'),
            gpsDesc: document.getElementById('gpsStatusDesc'),
            gpsSpinner: document.getElementById('gpsSpinner'),
            retryBtn: document.getElementById('retryGpsBtn'),
            distInfo: document.getElementById('distanceInfo'),
            distVal: document.getElementById('distVal'),
            form: document.getElementById('attendanceForm'),
            submitBtn: document.getElementById('submitBtn'),
            activityInfo: document.getElementById('activityInfo'),
            actTitle: document.getElementById('actTitle'),
            actPoints: document.getElementById('actPoints'),
            studentId: document.getElementById('student_id'),
            studentName: document.getElementById('student_name'),
            faculty: document.getElementById('faculty'),
            clazz: document.getElementById('class')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for debug/test inputs and sweep them if needed (keeping original cleanup logic conceptually)

            // 1. Get URL Params
            const params = new URLSearchParams(window.location.search);
            state.qrCodeId = params.get('qr_code_id') || params.get('session_id'); // Support both
            const activityId = params.get('activity_id');

            if (activityId) document.getElementById('activity_id').value = activityId;
            if (state.qrCodeId) document.getElementById('session_id').value = state.qrCodeId;

            // 2. Load Master Data
            await loadMasterData();

            // 3. Request Location IMMEDIATELY (High Priority)
            requestLocation();

            // 4. Validate QR (Get Target Location)
            if (state.qrCodeId) {
                validateQR(state.qrCodeId);
            }
        });

        // ---------------------------------------------------------
        // GEOLOCATION LOGIC
        // ---------------------------------------------------------
        function requestLocation() {
            updateGpsStatus('loading', 'ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...', 'M√°y s·∫Ω h·ªèi quy·ªÅn truy c·∫≠p GPS...');
            els.retryBtn.style.display = 'none';

            if (!navigator.geolocation) {
                updateGpsStatus('error', 'Kh√¥ng h·ªó tr·ª£ GPS', 'Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };

            const success = (pos) => {
                const { latitude, longitude, accuracy } = pos.coords;
                state.currentLocation = { latitude, longitude, accuracy };
                console.log('üìç Got Location:', state.currentLocation);

                checkDistance(); // Re-calculate distance

                // Visual Update
                updateGpsStatus('success', 'ƒê√£ l·∫•y ƒë∆∞·ª£c v·ªã tr√≠', `ƒê·ªô ch√≠nh x√°c: ¬±${Math.round(accuracy)}m`);
                els.retryBtn.style.display = 'none';
            };

            const error = (err) => {
                console.warn('GPS Error:', err);
                let msg = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠';
                let desc = 'Vui l√≤ng th·ª≠ l·∫°i';

                if (err.code === 1) { // PERMISSION_DENIED
                    msg = 'Quy·ªÅn GPS b·ªã t·ª´ ch·ªëi';
                    desc = 'H√£y v√†o C√†i ƒë·∫∑t > Quy·ªÅn ri√™ng t∆∞ > B·∫≠t V·ªã tr√≠ cho tr√¨nh duy·ªát v√† t·∫£i l·∫°i trang.';
                } else if (err.code === 2) { // POSITION_UNAVAILABLE
                    msg = 'V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng';
                    desc = 'Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† GPS tr√™n m√°y.';
                } else if (err.code === 3) { // TIMEOUT
                    msg = 'H·∫øt th·ªùi gian ch·ªù';
                    desc = 'Vui l√≤ng di chuy·ªÉn ra n∆°i tho√°ng v√† th·ª≠ l·∫°i.';
                }

                updateGpsStatus('error', msg, desc);
                els.retryBtn.style.display = 'block';
            };

            navigator.geolocation.getCurrentPosition(success, error, options);
        }

        els.retryBtn.addEventListener('click', () => {
            requestLocation();
        });

        function updateGpsStatus(type, title, desc) {
            els.gpsCard.className = `status-card ${type}`;
            els.gpsTitle.textContent = title;
            els.gpsDesc.textContent = desc;
            els.gpsSpinner.style.display = type === 'loading' ? 'block' : 'none';
        }

        // ---------------------------------------------------------
        // DISTANCE CALCULATION (Client Side)
        // ---------------------------------------------------------
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        function checkDistance() {
            // Need both locations to check
            if (!state.currentLocation || !state.targetLocation) return;

            const dist = calculateDistance(
                state.currentLocation.latitude,
                state.currentLocation.longitude,
                state.targetLocation.latitude,
                state.targetLocation.longitude
            );

            state.distance = dist;
            els.distInfo.style.display = 'block';
            els.distVal.textContent = Math.round(dist);

            // If Geofence is active
            if (state.geofenceRadius) {
                if (dist <= state.geofenceRadius) {
                    state.isLocationValid = true;
                    els.distInfo.className = 'distance-indicator distance-good';
                    els.distInfo.innerHTML = `üéØ OK: C√°ch ${Math.round(dist)}m (Trong ph·∫°m vi ${state.geofenceRadius}m)`;
                } else {
                    state.isLocationValid = false;
                    els.distInfo.className = 'distance-indicator distance-bad';
                    els.distInfo.innerHTML = `‚ö†Ô∏è QU√Å XA: C√°ch ${Math.round(dist)}m (Y√™u c·∫ßu < ${state.geofenceRadius}m)`;
                }
            } else {
                state.isLocationValid = true; // No geofence = always valid
                els.distInfo.innerHTML = `üìç Kho·∫£ng c√°ch: ${Math.round(dist)}m (Kh√¥ng gi·ªõi h·∫°n)`;
            }
        }

        // ---------------------------------------------------------
        // API INTERACTIONS
        // ---------------------------------------------------------
        async function validateQR(qrId) {
            try {
                const res = await fetch(`${API_BASE_URL}/attendances/validate-qr`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qr_code_id: qrId })
                });
                const data = await res.json();

                if (!data.valid) {
                    // Redirect or show error
                    window.location.href = '/404.html';
                    return;
                }

                // Store Target params
                if (data.location && data.location.latitude) {
                    state.targetLocation = {
                        latitude: data.location.latitude,
                        longitude: data.location.longitude
                    };
                    state.geofenceRadius = data.geofence_radius_m || null;

                    console.log('üéØ Target Location:', state.targetLocation);
                    checkDistance();
                }

                // Update UI Info
                els.activityInfo.style.display = 'block';
                // Need to fetch activity details if not fully in QR response
                // But QR response now has max_points
                els.actPoints.textContent = (data.max_points || 0) + ' ƒëi·ªÉm';

                // Fetch Activity Title separately if needed or if provided
                // The new endpoint response doesn't seem to include title directly unless we added it?
                // Actually the API sends `activity_id` and existing code fetched details.
                // Let's check `predictPoints` equivalent logic from old code.
                if (data.activity_id) {
                    fetchActivityDetails(data.activity_id);
                }

            } catch (err) {
                console.error('QR Validation Error:', err);
            }
        }

        async function fetchActivityDetails(activityId) {
            try {
                const res = await fetch(`${API_BASE_URL}/activities/${activityId}`);
                const data = await res.json();
                if (data.success) {
                    els.actTitle.textContent = data.data.title;
                }
            } catch (e) { console.error(e); }
        }

        async function loadMasterData() {
            try {
                const res = await fetch(`${API_BASE_URL}/attendances/master-data`);
                const result = await res.json();

                if (result.success) {
                    const facultySelect = els.faculty;
                    result.data.faculties.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f._id;
                        opt.textContent = f.name;
                        facultySelect.appendChild(opt);
                    });

                    // Class logic
                    const allClasses = result.data.classes || [];
                    facultySelect.addEventListener('change', (e) => {
                        const facId = e.target.value;
                        const classSelect = els.clazz;
                        classSelect.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
                        classSelect.disabled = !facId;

                        if (facId) {
                            const filtered = allClasses.filter(c => c.faculty_id === facId);
                            filtered.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c._id;
                                opt.textContent = c.name;
                                classSelect.appendChild(opt);
                            });
                        }
                    });
                }
            } catch (err) {
                showToast('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu khoa/l·ªõp');
            }
        }

        // ---------------------------------------------------------
        // SUBMISSION
        // ---------------------------------------------------------
        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. Basic Validation
            if (!els.studentName.value || !els.studentId.value || !els.faculty.value || !els.clazz.value) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin');
                return;
            }
            if (!/^\d{9}$/.test(els.studentId.value)) {
                showToast('MSSV kh√¥ng h·ª£p l·ªá (9 s·ªë)');
                return;
            }

            // 2. Geofence Validation (Client Side Block)
            if (state.geofenceRadius && !state.isLocationValid) {
                if (!state.currentLocation) {
                    showToast('‚ö†Ô∏è C·∫ßn b·∫≠t v·ªã tr√≠ ƒë·ªÉ ƒëi·ªÉm danh!');
                    requestLocation();
                } else {
                    showToast(`‚ö†Ô∏è B·∫°n ƒëang qu√° xa! (C√°ch ${Math.round(state.distance)}m)`);
                }
                return;
            }

            // 3. Submit
            setLoading(true);
            try {
                const payload = {
                    activity_id: document.getElementById('activity_id').value,
                    session_id: state.qrCodeId || null, // Ensure session_id (QR ID) is sent
                    student_info: {
                        student_id_number: els.studentId.value,
                        student_name: els.studentName.value,
                        class: els.clazz.value,
                        faculty: els.faculty.value
                    },
                    scan_location: state.currentLocation
                };

                const res = await fetch(`${API_BASE_URL}/attendances/submit-attendance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (res.ok) {
                    // Success UI
                    document.body.innerHTML = `
                        <div class="container" style="text-align: center;">
                            <div style="font-size: 50px; margin-bottom: 20px;">‚úÖ</div>
                            <h2>ƒêi·ªÉm danh th√†nh c√¥ng!</h2>
                            <p style="color: green; font-weight: bold; margin-top: 10px;">+${result.data?.points_earned || 0} ƒëi·ªÉm</p>
                            <p style="margin-top: 20px; color: #666;">C·∫£m ∆°n b·∫°n ƒë√£ tham gia.</p>
                            <button onclick="window.location.reload()" class="btn" style="margin-top: 30px;">Quay l·∫°i</button>
                        </div>
                    `;
                } else {
                    showToast(result.message || 'C√≥ l·ªói x·∫£y ra');
                }

            } catch (err) {
                showToast('L·ªói k·∫øt n·ªëi server');
                console.error(err);
            } finally {
                setLoading(false);
            }
        });

        // ---------------------------------------------------------
        // UTILS
        // ---------------------------------------------------------
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function setLoading(isLoading) {
            const btn = els.submitBtn;
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div> ƒêang g·ª≠i...';
            } else {
                btn.disabled = false;
                btn.textContent = 'N·ªôp ƒêi·ªÉm Danh';
            }
        }

    </script>
</body>

</html>