<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n quy·ªÅn cho t√†i kho·∫£n ng∆∞·ªùi d√πng</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .role-selection {
            margin: 20px 0;
        }

        .role-selection label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
        }

        .role-selection input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .btn-select-permissions {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: background 0.3s;
        }

        .btn-select-permissions:hover {
            background: #5568d3;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .action-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }

        .action-card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .action-item {
            margin-bottom: 12px;
        }

        .action-item label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .action-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .org-role-section {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 2px solid #667eea;
        }

        .org-role-section.show {
            display: block;
        }

        .org-role-section .form-group {
            margin-bottom: 15px;
        }

        .org-role-section select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-confirm {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            float: right;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .btn-confirm:hover {
            background: #5568d3;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .user-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .user-info h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .user-info p {
            margin: 5px 0;
            color: #666;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-content h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .login-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #5568d3;
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }

        .user-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-logout:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="login-modal" id="login-modal">
        <div class="login-content">
            <h2>ƒêƒÉng nh·∫≠p</h2>
            <div class="login-error" id="login-error"></div>
            <form onsubmit="handleLogin(event)">
                <div class="login-form-group">
                    <label for="login-username">T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="login-form-group">
                    <label for="login-password">M·∫≠t kh·∫©u:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="login-btn" id="login-btn">ƒêƒÉng nh·∫≠p</button>
            </form>
        </div>
    </div>

    <div class="header">
        <h1>Ph√¢n quy·ªÅn cho t√†i kho·∫£n ng∆∞·ªùi d√πng</h1>
    </div>

    <div class="container">
        <div class="user-header" id="user-header" style="display: none;">
            <div class="user-header-info">
                <span id="user-info-text">ƒêang t·∫£i...</span>
            </div>
            <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
        <div class="error" id="error-message"></div>
        <div class="success" id="success-message"></div>
        <div class="loading" id="loading">
            <p>ƒêang t·∫£i...</p>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="username">T√™n ƒëƒÉng nh·∫≠p:</label>
                <input type="text" id="username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
            </div>
            <button class="btn-select-permissions" onclick="loadUserPermissions()">Ch·ªçn c√°c quy·ªÅn ƒë∆∞·ª£c ph√©p s·ª≠ d·ª•ng</button>
        </div>

        <div id="user-info-section" style="display: none;">
            <div class="user-info">
                <h4>Th√¥ng tin ng∆∞·ªùi d√πng</h4>
                <p id="user-info-text"></p>
            </div>

            <div class="form-section">
                <label>Ch·ªçn vai tr√≤:</label>
                <div class="role-selection">
                    <label>
                        <input type="checkbox" id="role-student" value="student" onchange="handleRoleChange()">
                        Sinh vi√™n
                    </label>
                    <label>
                        <input type="checkbox" id="role-org" value="org" onchange="handleRoleChange()">
                        T·ªï ch·ª©c
                    </label>
                    <label>
                        <input type="checkbox" id="role-admin" value="admin" onchange="handleRoleChange()">
                        Admin
                    </label>
                </div>
            </div>

            <div class="org-role-section" id="org-role-section">
                <h4>Th√¥ng tin vai tr√≤ t·ªï ch·ª©c</h4>
                <div class="form-group">
                    <label for="org-unit-select">ƒê∆°n v·ªã t·ªï ch·ª©c:</label>
                    <select id="org-unit-select">
                        <option value="">-- Ch·ªçn ƒë∆°n v·ªã t·ªï ch·ª©c --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="position-select">Ch·ª©c v·ª•:</label>
                    <select id="position-select">
                        <option value="">-- Ch·ªçn ch·ª©c v·ª• --</option>
                    </select>
                </div>
            </div>

            <div id="actions-section" style="display: none;">
                <div class="actions-grid" id="actions-grid">
                    <!-- Actions will be loaded here -->
                </div>
            </div>

            <button class="btn-confirm" onclick="savePermissions()">X√°c nh·∫≠n</button>
            <div style="clear: both;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : 'https://pbl6-backend-iy5q.onrender.com/api';

        let currentUser = null;
        let currentUserId = null;
        let allActions = [];
        let allResources = [];
        let userPermissions = {};
        let userOverrides = {};
        let loggedInUser = null;

        // Check authentication on load
        window.addEventListener('load', () => {
            const token = getToken();
            const savedUser = localStorage.getItem('user');
            
            if (token && savedUser) {
                try {
                    loggedInUser = JSON.parse(savedUser);
                    verifyToken(token);
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    showLoginModal();
                }
            } else {
                showLoginModal();
            }
        });

        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('user-header').style.display = 'none';
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('user-header').style.display = 'flex';
        }

        async function verifyToken(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    loggedInUser = data.user;
                    localStorage.setItem('user', JSON.stringify(data.user));
                    hideLoginModal();
                    loadOrgUnits();
                    loadPositions();
                    updateUserInfo();
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    showLoginModal();
                }
            } catch (error) {
                console.error('Token verification error:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                showLoginModal();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            loginError.classList.remove('show');
            loginBtn.disabled = true;
            loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    localStorage.setItem('token', data.token);
                    loggedInUser = data.user;
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    hideLoginModal();
                    loadOrgUnits();
                    loadPositions();
                    updateUserInfo();
                } else {
                    loginError.textContent = data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
                    loginError.classList.add('show');
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
                loginError.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ƒêƒÉng nh·∫≠p';
            }
        }

        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                loggedInUser = null;
                showLoginModal();
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('user-info-section').style.display = 'none';
                document.getElementById('actions-section').style.display = 'none';
            }
        }

        function updateUserInfo() {
            const userInfoText = document.getElementById('user-info-text');
            if (loggedInUser) {
                const roles = loggedInUser.roles && loggedInUser.roles.length > 0 
                    ? loggedInUser.roles.map(r => r.role).join(', ') 
                    : 'Kh√¥ng c√≥ role';
                userInfoText.textContent = `üë§ ${loggedInUser.username} - ${roles}`;
            } else {
                userInfoText.textContent = 'ƒêang t·∫£i...';
            }
        }

        function getToken() {
            return localStorage.getItem('token') || '';
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.classList.add('show');
            setTimeout(() => successEl.classList.remove('show'), 5000);
        }

        async function loadOrgUnits() {
            try {
                const response = await fetch(`${API_BASE_URL}/org-units`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) return;
                const data = await response.json();
                const select = document.getElementById('org-unit-select');
                if (Array.isArray(data)) {
                    data.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit._id;
                        option.textContent = unit.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading org units:', error);
            }
        }

        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE_URL}/staff-profiles/positions`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) return;
                const result = await response.json();
                const select = document.getElementById('position-select');
                if (result.success && Array.isArray(result.data)) {
                    result.data.forEach(position => {
                        const option = document.createElement('option');
                        option.value = position;
                        option.textContent = position;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function loadUserPermissions() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showError('Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p');
                return;
            }

            document.getElementById('loading').classList.add('show');
            document.getElementById('user-info-section').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/permissions/users/username/${username}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng');
                }

                const result = await response.json();
                currentUser = result.user;
                currentUserId = result.user.id;
                userPermissions = result.permissions || {};
                userOverrides = {};

                // Build overrides map
                if (result.overrides) {
                    result.overrides.forEach(override => {
                        if (override.action_id) {
                            userOverrides[override.action_id] = override.is_granted;
                        }
                    });
                }

                // Display user info
                document.getElementById('user-info-text').textContent = 
                    `Username: ${result.user.username} | Lo·∫°i: ${result.user.userType}`;
                document.getElementById('user-info-section').style.display = 'block';

                // Update role checkboxes based on user roles
                updateRoleCheckboxes(result.roles);

                // Load all actions and display
                await loadAllActions();
                displayActions();

            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        function updateRoleCheckboxes(roles) {
            // Reset checkboxes
            document.getElementById('role-student').checked = false;
            document.getElementById('role-org').checked = false;
            document.getElementById('role-admin').checked = false;

            // Check based on user roles
            roles.forEach(role => {
                const roleName = role.role?.toLowerCase();
                if (roleName === 'student') {
                    document.getElementById('role-student').checked = true;
                } else if (roleName === 'admin') {
                    document.getElementById('role-admin').checked = true;
                } else if (role.orgUnit || roleName === 'staff') {
                    // Has org role (staff role with org_unit)
                    document.getElementById('role-org').checked = true;
                }
            });
        }

        async function loadAllActions() {
            try {
                const response = await fetch(`${API_BASE_URL}/permissions/actions?is_active=true`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (!response.ok) return;

                const result = await response.json();
                allActions = result.data || [];

                // Group by resource
                const resourcesMap = {};
                allActions.forEach(action => {
                    if (!resourcesMap[action.resource]) {
                        resourcesMap[action.resource] = [];
                    }
                    resourcesMap[action.resource].push(action);
                });

                allResources = Object.keys(resourcesMap);
            } catch (error) {
                console.error('Error loading actions:', error);
            }
        }

        function displayActions() {
            const grid = document.getElementById('actions-grid');
            grid.innerHTML = '';

            allResources.forEach(resource => {
                const actions = allActions.filter(a => a.resource === resource);
                if (actions.length === 0) return;

                const card = document.createElement('div');
                card.className = 'action-card';
                card.innerHTML = `<h3>${resource}</h3>`;

                actions.forEach(action => {
                    const actionItem = document.createElement('div');
                    actionItem.className = 'action-item';
                    
                    // Check if user has this permission
                    const hasPermission = userPermissions[resource]?.some(
                        p => p.action_code === action.action_code
                    ) || false;
                    
                    // Check override
                    const override = userOverrides[action._id];
                    const isChecked = override !== undefined ? override : hasPermission;

                    actionItem.innerHTML = `
                        <label>
                            <input type="checkbox" 
                                   data-action-id="${action._id}"
                                   data-resource="${action.resource}"
                                   data-action-code="${action.action_code}"
                                   ${isChecked ? 'checked' : ''}>
                            ${action.action_name || action.action_code}
                        </label>
                    `;
                    card.appendChild(actionItem);
                });

                grid.appendChild(card);
            });

            document.getElementById('actions-section').style.display = 'block';
        }

        function handleRoleChange() {
            const orgChecked = document.getElementById('role-org').checked;
            const studentChecked = document.getElementById('role-student').checked;
            const orgSection = document.getElementById('org-role-section');

            // Show org role section only if org is checked and user is student
            if (orgChecked && studentChecked && currentUser?.userType === 'student') {
                orgSection.classList.add('show');
            } else {
                orgSection.classList.remove('show');
            }
        }

        async function savePermissions() {
            if (!currentUserId) {
                showError('Vui l√≤ng t·∫£i th√¥ng tin ng∆∞·ªùi d√πng tr∆∞·ªõc');
                return;
            }

            document.getElementById('loading').classList.add('show');

            try {
                // Collect all action overrides
                const checkboxes = document.querySelectorAll('#actions-grid input[type="checkbox"]');
                const actions = [];

                checkboxes.forEach(cb => {
                    const actionId = cb.getAttribute('data-action-id');
                    const isGranted = cb.checked;
                    actions.push({
                        action_id: actionId,
                        is_granted: isGranted
                    });
                });

                // Update permissions
                const response = await fetch(`${API_BASE_URL}/permissions/users/${currentUserId}/permissions`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ actions })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'L·ªói khi c·∫≠p nh·∫≠t quy·ªÅn');
                }

                // If org role is selected for student, assign it
                const orgChecked = document.getElementById('role-org').checked;
                const studentChecked = document.getElementById('role-student').checked;
                
                if (orgChecked && studentChecked && currentUser?.userType === 'student') {
                    const orgUnitId = document.getElementById('org-unit-select').value;
                    const position = document.getElementById('position-select').value;

                    if (!orgUnitId) {
                        showError('Vui l√≤ng ch·ªçn ƒë∆°n v·ªã t·ªï ch·ª©c');
                        return;
                    }

                    // Get staff role ID (role for organization units)
                    const rolesResponse = await fetch(`${API_BASE_URL}/permissions/roles`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (rolesResponse.ok) {
                        const rolesResult = await rolesResponse.json();
                        const orgRole = rolesResult.data?.find(r => 
                            r.name.toLowerCase() === 'staff' ||
                            r.name.toLowerCase() === 't·ªï ch·ª©c' || 
                            r.name.toLowerCase() === 'org' ||
                            r.name.toLowerCase() === 'organization'
                        );

                        if (orgRole) {
                            await fetch(`${API_BASE_URL}/permissions/users/${currentUserId}/assign-org-role`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${getToken()}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    role_id: orgRole._id,
                                    org_unit_id: orgUnitId,
                                    position: position || undefined
                                })
                            });
                        }
                    }
                }

                showSuccess('C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!');
                
                // Reload user permissions
                setTimeout(() => {
                    loadUserPermissions();
                }, 1000);

            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }
    </script>
</body>
</html>

