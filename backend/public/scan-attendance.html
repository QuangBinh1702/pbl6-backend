<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Qu√©t ƒêi·ªÉm Danh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid #10b981;
            pointer-events: none;
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            border: 3px solid #10b981;
            box-shadow: inset 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95em;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
            display: block;
        }

        .message.info {
            background: #dbeafe;
            color: #0c4a6e;
            border: 1px solid #bfdbfe;
            display: block;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .status-text {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .card {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Qu√©t ƒêi·ªÉm Danh</h1>
            <p>Qu√©t m√£ QR ƒë·ªÉ ƒëi·ªÉm danh</p>
        </div>

        <!-- Scanner Section -->
        <div class="card" id="scannerSection">
            <h2>üì∏ Qu√©t M√£ QR</h2>
            
            <div id="scanner-container">
                <video id="video" playsinline></video>
                <div class="scanner-overlay"></div>
            </div>

            <div class="status-text" id="scannerStatus">ƒêang kh·ªüi ƒë·ªông camera...</div>
            <button class="btn-secondary" style="margin-top: 15px;" onclick="stopScanner()">‚ùå H·ªßy Qu√©t</button>
            
            <div id="scannerMessage" class="message" style="margin-top: 15px;"></div>
        </div>

        <!-- Form Section (hidden until QR scanned) -->
        <div class="card" id="formSection" style="display: none;">
            <h2>‚úÖ Th√¥ng Tin ƒêi·ªÉm Danh</h2>

            <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <p><strong>Ho·∫°t ƒë·ªông:</strong> <span id="activityName">-</span></p>
                <p><strong>M√£ QR:</strong> <span id="qrIdDisplay">-</span></p>
                <p><strong>Th·ªùi gian:</strong> <span id="qrTime">-</span></p>
            </div>

            <div class="form-group">
                <label>H·ªç v√† T√™n *</label>
                <input type="text" id="studentName" placeholder="Nguy·ªÖn VƒÉn A" maxlength="100" required>
            </div>

            <div class="form-group">
                <label>MSSV (5-6 ch·ªØ s·ªë) *</label>
                <input type="text" id="mssv" placeholder="20001" maxlength="6" pattern="\d{5,6}">
            </div>

            <div class="form-group">
                <label>L·ªõp *</label>
                <select id="class" required>
                    <option value="">-- Ch·ªçn L·ªõp --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Khoa *</label>
                <select id="faculty" required>
                    <option value="">-- Ch·ªçn Khoa --</option>
                </select>
            </div>

            <div class="form-group">
                <label>ƒêi·ªán tho·∫°i (t√πy ch·ªçn)</label>
                <input type="tel" id="phone" placeholder="0912345678">
            </div>

            <div class="form-group">
                <label>Ghi ch√∫ (t·ªëi ƒëa 500 k√Ω t·ª±)</label>
                <textarea id="notes" placeholder="Ghi ch√∫..." maxlength="500" rows="3"></textarea>
                <small style="color: #999;">K√Ω t·ª±: <span id="charCount">0</span>/500</small>
            </div>

            <div class="button-group">
                <!-- üÜï GEOFENCE: Change submit to capture location first -->
                <button class="btn-success" onclick="captureLocationAndSubmit()">üìç G·ª≠i ƒêi·ªÉm Danh (L·∫•y GPS)</button>
                <button class="btn-secondary" onclick="resetForm()">üîÑ Qu√©t Ti·∫øp</button>
            </div>

            <div id="formMessage" class="message" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- QR Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.js"></script>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentQRData = null;
        let currentActivityId = null;
        let currentQRId = null;
        let scannerActive = false;
        let videoStream = null;

        // ===== SCANNER =====
        async function startScanner() {
            try {
                const video = document.getElementById('video');
                
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = videoStream;
                video.play();
                
                updateScannerStatus('‚úÖ Camera s·∫µn s√†ng. H∆∞·ªõng QR v√†o camera...');
                scanQRCode();
            } catch (error) {
                showMessage('scannerMessage', `‚ùå L·ªói camera: ${error.message}`, 'error');
                updateScannerStatus('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera');
                console.error('Camera error:', error);
            }
        }

        function stopScanner() {
            scannerActive = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('scannerSection').style.display = 'none';
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('scannerStatus').textContent = 'Camera d·ª´ng';
        }

        function updateScannerStatus(text) {
            document.getElementById('scannerStatus').textContent = text;
        }

        // ===== QR DETECTION =====
        function scanQRCode() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            scannerActive = true;

            function scan() {
                if (!scannerActive) return;

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    if (code) {
                        // QR detected!
                        console.log('QR detected:', code.data);
                        processQRData(code.data);
                        scannerActive = false;
                        return;
                    }
                }

                requestAnimationFrame(scan);
            }

            scan();
        }

        // ===== PROCESS QR DATA =====
        async function processQRData(qrDataStr) {
            try {
                // Parse QR data (should be JSON)
                let qrData = JSON.parse(qrDataStr);
                
                console.log('QR Data:', qrData);

                currentQRData = qrData;
                currentActivityId = qrData.activityId;
                currentQRId = qrData.qrId;

                // Stop scanner
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }

                // Show form
                await showSubmissionForm(qrData);

                // Hide scanner, show form
                document.getElementById('scannerSection').style.display = 'none';
                document.getElementById('formSection').style.display = 'block';

                updateScannerStatus('‚úÖ QR qu√©t th√†nh c√¥ng!');
            } catch (error) {
                showMessage('scannerMessage', `‚ùå L·ªói: QR kh√¥ng h·ª£p l·ªá - ${error.message}`, 'error');
                // Continue scanning
                scanQRCode();
            }
        }

        // ===== LOAD FORM DATA =====
        async function showSubmissionForm(qrData) {
            try {
                const token = localStorage.getItem('testToken') || '';

                // Get activity details
                const actRes = await fetch(
                    `${API_BASE}/activities/${qrData.activityId}`,
                    {
                        headers: { Authorization: `Bearer ${token}` }
                    }
                );

                let activityTitle = 'Kh√¥ng x√°c ƒë·ªãnh';
                if (actRes.ok) {
                    const actData = await actRes.json();
                    activityTitle = actData.data?.title || activityTitle;
                }

                // Get master data (classes & faculties)
                const masterRes = await fetch(`${API_BASE}/attendances/master-data`);
                const masterData = await masterRes.json();
                const classes = masterData.data?.classes || [];
                const faculties = masterData.data?.faculties || [];

                // Populate dropdowns
                const classSelect = document.getElementById('class');
                const facultySelect = document.getElementById('faculty');

                classSelect.innerHTML = '<option value="">-- Ch·ªçn L·ªõp --</option>' +
                    classes.map(c => `<option value="${c._id}">${c.name}</option>`).join('');

                facultySelect.innerHTML = '<option value="">-- Ch·ªçn Khoa --</option>' +
                    faculties.map(f => `<option value="${f._id}">${f.name}</option>`).join('');

                // Display QR info
                document.getElementById('activityName').textContent = activityTitle;
                document.getElementById('qrIdDisplay').textContent = qrData.qrId || 'N/A';
                document.getElementById('qrTime').textContent = new Date(qrData.createdAt).toLocaleString('vi-VN');

            } catch (error) {
                showMessage('formMessage', `‚ùå L·ªói t·∫£i form: ${error.message}`, 'error');
            }
        }

        // üÜï GEOFENCE: Capture location before submitting form
         async function captureLocationAndSubmit() {
             try {
                 const studentName = document.getElementById('studentName').value;
                 const mssv = document.getElementById('mssv').value;
                 const classId = document.getElementById('class').value;
                 const facultyId = document.getElementById('faculty').value;
                 const phone = document.getElementById('phone').value;
                 const notes = document.getElementById('notes').value;

                 // Validation
                 if (!studentName || !mssv || !classId || !facultyId) {
                     showMessage('formMessage', '‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (*)', 'error');
                     return;
                 }

                 if (!/^\d{5,6}$/.test(mssv)) {
                     showMessage('formMessage', '‚ùå MSSV ph·∫£i l√† 5-6 ch·ªØ s·ªë', 'error');
                     return;
                 }

                 if (phone && !/^(0|\+84)\d{9,10}$/.test(phone)) {
                     showMessage('formMessage', '‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá', 'error');
                     return;
                 }

                 // üÜï GEOFENCE: Get location
                 showMessage('formMessage', 'üìç ƒêang l·∫•y v·ªã tr√≠ c·ªßa b·∫°n...', 'info');
                 
                 const position = await new Promise((resolve, reject) => {
                     navigator.geolocation.getCurrentPosition(
                         resolve,
                         reject,
                         { 
                             enableHighAccuracy: true, 
                             timeout: 15000,
                             maximumAge: 0
                         }
                     );
                 });

                 const scanLocation = {
                     latitude: position.coords.latitude,
                     longitude: position.coords.longitude,
                     accuracy: position.coords.accuracy
                 };

                 // Submit attendance with location
                 await submitForm(scanLocation);

             } catch (error) {
                 if (error.code === error.PERMISSION_DENIED) {
                     showMessage('formMessage', '‚ùå C·∫ßn b·∫≠t Permission v·ªã tr√≠. Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p v·ªã tr√≠', 'error');
                 } else if (error.code === error.TIMEOUT) {
                     showMessage('formMessage', '‚ùå Timeout l·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá nh√¢n vi√™n', 'error');
                 } else {
                     showMessage('formMessage', `‚ùå L·ªói: ${error.message}`, 'error');
                 }
                 console.error(error);
             }
         }

         // ===== SUBMIT FORM =====
         async function submitForm(scanLocation = null) {
             try {
                 const studentName = document.getElementById('studentName').value;
                 const mssv = document.getElementById('mssv').value;
                 const classId = document.getElementById('class').value;
                 const facultyId = document.getElementById('faculty').value;
                 const phone = document.getElementById('phone').value;
                 const notes = document.getElementById('notes').value;

                 const token = localStorage.getItem('testToken') || '';

                 // Submit attendance
                 const submitRes = await fetch(`${API_BASE}/attendances/submit-attendance`, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify({
                         activity_id: currentActivityId,
                         session_id: currentQRId,
                         student_info: {
                             student_id_number: mssv,
                             student_name: studentName,
                             class: classId,
                             faculty: facultyId,
                             phone: phone || null,
                             notes: notes || null
                         },
                         // üÜï GEOFENCE: Include scan location
                         scan_location: scanLocation
                     })
                 });

                 if (!submitRes.ok) {
                     const error = await submitRes.json();
                     throw new Error(error.message || 'G·ª≠i th·∫•t b·∫°i');
                 }

                 const result = await submitRes.json();
                 
                 // üÜï Show location verification result if available
                 let successMsg = '‚úÖ G·ª≠i ƒëi·ªÉm danh th√†nh c√¥ng! Vui l√≤ng ch·ªù duy·ªát.';
                 if (result.data?.location_data) {
                     const loc = result.data.location_data;
                     successMsg += `\nüìç Kho·∫£ng c√°ch: ${loc.distance_m}m (cho ph√©p ${loc.required_distance_m}m)`;
                 }
                 
                 showMessage('formMessage', successMsg, 'success');

                 // Reset after 3 seconds
                 setTimeout(() => {
                     resetForm();
                 }, 3000);

             } catch (error) {
                 showMessage('formMessage', `‚ùå L·ªói: ${error.message}`, 'error');
                 console.error(error);
             }
         }

        function resetForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('mssv').value = '';
            document.getElementById('class').value = '';
            document.getElementById('faculty').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('formMessage').innerHTML = '';

            document.getElementById('formSection').style.display = 'none';
            document.getElementById('scannerSection').style.display = 'block';

            startScanner();
        }

        function showMessage(elementId, msg, type) {
            const el = document.getElementById(elementId);
            el.className = `message ${type}`;
            el.textContent = msg;
            if (type === 'success') {
                setTimeout(() => el.innerHTML = '', 3000);
            }
        }

        // Character counter
        document.addEventListener('DOMContentLoaded', () => {
            const notesInput = document.getElementById('notes');
            if (notesInput) {
                notesInput.addEventListener('input', (e) => {
                    document.getElementById('charCount').textContent = e.target.value.length;
                });
            }
        });

        // Parse QR data from URL if available
        function parseQRFromURL() {
            const params = new URLSearchParams(window.location.search);
            const dataParam = params.get('data');

            if (dataParam) {
                try {
                    const qrData = JSON.parse(decodeURIComponent(dataParam));
                    console.log('QR data from URL:', qrData);
                    processQRData(JSON.stringify(qrData));
                    return true;
                } catch (error) {
                    console.error('Error parsing QR data from URL:', error);
                    return false;
                }
            }
            return false;
        }

        // Parse JSON if user paste/input QR data directly
        function parseQRFromInput() {
            const urlParam = new URLSearchParams(window.location.search).get('text');
            if (!urlParam) return false;

            try {
                // If text contains http://...?data=, extract data part
                if (urlParam.includes('?data=')) {
                    const dataStr = urlParam.split('?data=')[1];
                    const qrData = JSON.parse(decodeURIComponent(dataStr));
                    console.log('QR from URL text:', qrData);
                    processQRData(JSON.stringify(qrData));
                    return true;
                }
                
                // If direct JSON text
                const qrData = JSON.parse(urlParam);
                console.log('QR from JSON text:', qrData);
                processQRData(JSON.stringify(qrData));
                return true;
            } catch (e) {
                console.error('Error parsing input:', e);
                return false;
            }
        }

        // Start scanner on load
        window.addEventListener('load', () => {
            // Check if QR data in URL (from desktop QR code)
            if (!parseQRFromURL() && !parseQRFromInput()) {
                // Otherwise start camera scanner
                startScanner();
            }
        });

        // Add manual paste button for testing
        document.addEventListener('DOMContentLoaded', () => {
            const card = document.querySelector('.card');
            if (card) {
                const pasteBtn = document.createElement('button');
                pasteBtn.className = 'btn-secondary';
                pasteBtn.style.marginTop = '10px';
                pasteBtn.textContent = 'üìã D√°n QR Data (Test)';
                pasteBtn.onclick = () => {
                    const data = prompt('Paste QR JSON data:');
                    if (data) {
                        try {
                            const qrData = JSON.parse(data);
                            processQRData(data);
                        } catch (e) {
                            alert('‚ùå JSON kh√¥ng h·ª£p l·ªá: ' + e.message);
                        }
                    }
                };
                card.querySelector('.button-group')?.parentElement?.insertBefore(pasteBtn, card.querySelector('.button-group'));
            }
        });
    </script>
</body>
</html>
