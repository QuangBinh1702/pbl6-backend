<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Activity Filter Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
      }

      .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: white;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: all 0.3s;
      }

      .tab-btn:hover {
        background: #f5f5f5;
      }

      .tab-btn.active {
        border-bottom: 3px solid #667eea;
        color: #667eea;
      }

      .tab-content {
        display: none;
        padding: 30px;
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.95em;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }

      .btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-search {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-reset {
        background: #f0f0f0;
        color: #333;
      }

      .btn-reset:hover {
        background: #e0e0e0;
      }

      .loading {
        text-align: center;
        padding: 20px;
        display: none;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
      }

      .error.show {
        display: block;
      }

      .results {
        margin-top: 30px;
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 5px;
      }

      .results-header h3 {
        color: #333;
      }

      .count-badge {
        background: #667eea;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      table thead {
        background: #f9f9f9;
      }

      table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        color: #333;
      }

      table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
      }

      table tbody tr:hover {
        background: #f5f5f5;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
      }

      .status-approved {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-rejected {
        background: #f8d7da;
        color: #721c24;
      }

      .status-in_progress {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-cancelled {
        background: #e2e3e5;
        color: #383d41;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 3em;
        margin-bottom: 10px;
      }

      .json-view {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
      }

      .json-view pre {
        margin: 0;
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        color: #333;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }

        table {
          font-size: 0.85em;
        }

        table th,
        table td {
          padding: 8px 5px;
        }

        .header h1 {
          font-size: 1.5em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ Activity Filter Test</h1>
        <p>Ki·ªÉm tra API l·ªçc ho·∫°t ƒë·ªông</p>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all-activities')">
          üìã T·∫•t c·∫£ ho·∫°t ƒë·ªông
        </button>
        <button class="tab-btn" onclick="switchTab('student-activities')">
          üë§ Ho·∫°t ƒë·ªông c·ªßa sinh vi√™n
        </button>
      </div>

      <!-- Tab 1: T·∫•t c·∫£ ho·∫°t ƒë·ªông -->
      <div id="all-activities" class="tab-content active">
        <div class="error" id="error-all"></div>

        <form onsubmit="searchAllActivities(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="status-all">Tr·∫°ng th√°i ho·∫°t ƒë·ªông</label>
              <select id="status-all">
                <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                <option value="ch·ªù duy·ªát">Ch·ªù duy·ªát</option>
                <option value="ch∆∞a t·ªï ch·ª©c">Ch∆∞a t·ªï ch·ª©c</option>
                <option value="ƒëang t·ªï ch·ª©c">ƒêang t·ªï ch·ª©c</option>
                <option value="ƒë√£ t·ªï ch·ª©c">ƒê√£ t·ªï ch·ª©c</option>
                <option value="t·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
                <option value="h·ªßy ho·∫°t ƒë·ªông">H·ªßy ho·∫°t ƒë·ªông</option>
              </select>
            </div>
            <div class="form-group">
              <label for="post-status-all">Tr·∫°ng th√°i Post</label>
              <select id="post-status-all">
                <option value="">-- T·∫•t c·∫£ --</option>
                <option value="true">ƒê√£ post</option>
                <option value="false">Ch∆∞a post</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="field-all">Lƒ©nh v·ª±c</label>
              <input type="text" id="field-all" placeholder="Nh·∫≠p field_id" />
            </div>
            <div class="form-group">
              <label for="org-all">T·ªï ch·ª©c</label>
              <input type="text" id="org-all" placeholder="Nh·∫≠p org_unit_id" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="title-all">T√™n ho·∫°t ƒë·ªông</label>
              <input
                type="text"
                id="title-all"
                placeholder="Nh·∫≠p t·ª´ kh√≥a t√™n ho·∫°t ƒë·ªông"
                style="grid-column: 1 / -1"
              />
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-search">üîç T√¨m ki·∫øm</button>
            <button
              type="button"
              class="btn btn-reset"
              onclick="resetForm('all')"
            >
              üîÑ Reset
            </button>
          </div>
        </form>

        <div class="loading" id="loading-all">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i...</p>
        </div>

        <div class="results" id="results-all" style="display: none">
          <div class="results-header">
            <h3>üìä K·∫øt qu·∫£ t√¨m ki·∫øm</h3>
            <div class="count-badge" id="count-all">0 k·∫øt qu·∫£</div>
          </div>

          <div class="table-container">
            <table id="table-all">
              <thead>
                <tr>
                  <th>T√™n ho·∫°t ƒë·ªông</th>
                  <th>Lƒ©nh v·ª±c</th>
                  <th>T·ªï ch·ª©c</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Post</th>
                  <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                  <th>ƒê·ªãa ƒëi·ªÉm</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="json-view">
            <pre id="json-all">[]</pre>
          </div>
        </div>

        <div class="empty-state" id="empty-all" style="display: none">
          <div class="empty-state-icon">üì≠</div>
          <p>Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông n√†o</p>
        </div>
      </div>

      <!-- Tab 2: Ho·∫°t ƒë·ªông c·ªßa sinh vi√™n -->
      <div id="student-activities" class="tab-content">
        <div class="error" id="error-student"></div>

        <form onsubmit="searchStudentActivities(event)">
          <div class="form-group">
            <label for="student-id"
              >ID Sinh vi√™n <span style="color: red">*</span></label
            >
            <input
              type="text"
              id="student-id"
              placeholder="Nh·∫≠p student_id (b·∫Øt bu·ªôc)"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="status-student">Tr·∫°ng th√°i</label>
              <select id="status-student">
                <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                <option value="ch·ªù duy·ªát">Ch·ªù duy·ªát</option>
                <option value="ch∆∞a t·ªï ch·ª©c">Ch∆∞a t·ªï ch·ª©c</option>
                <option value="ƒëang t·ªï ch·ª©c">ƒêang t·ªï ch·ª©c</option>
                <option value="ƒë√£ t·ªï ch·ª©c">ƒê√£ t·ªï ch·ª©c</option>
                <option value="t·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
                <option value="h·ªßy ho·∫°t ƒë·ªông">H·ªßy ho·∫°t ƒë·ªông</option>
              </select>
            </div>
            <div class="form-group">
              <label for="post-status-student">Tr·∫°ng th√°i Post</label>
              <select id="post-status-student">
                <option value="">-- T·∫•t c·∫£ --</option>
                <option value="true">ƒê√£ post</option>
                <option value="false">Ch∆∞a post</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="field-student">Lƒ©nh v·ª±c</label>
              <input
                type="text"
                id="field-student"
                placeholder="Nh·∫≠p field_id"
              />
            </div>
            <div class="form-group">
              <label for="org-student">T·ªï ch·ª©c</label>
              <input
                type="text"
                id="org-student"
                placeholder="Nh·∫≠p org_unit_id"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="title-student">T√™n ho·∫°t ƒë·ªông</label>
              <input
                type="text"
                id="title-student"
                placeholder="Nh·∫≠p t·ª´ kh√≥a t√™n ho·∫°t ƒë·ªông"
                style="grid-column: 1 / -1"
              />
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-search">üîç T√¨m ki·∫øm</button>
            <button
              type="button"
              class="btn btn-reset"
              onclick="resetForm('student')"
            >
              üîÑ Reset
            </button>
          </div>
        </form>

        <div class="loading" id="loading-student">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i...</p>
        </div>

        <div class="results" id="results-student" style="display: none">
          <div class="results-header">
            <h3>üìä K·∫øt qu·∫£ t√¨m ki·∫øm</h3>
            <div class="count-badge" id="count-student">0 k·∫øt qu·∫£</div>
          </div>

          <div class="table-container">
            <table id="table-student">
              <thead>
                <tr>
                  <th>T√™n ho·∫°t ƒë·ªông</th>
                  <th>Lƒ©nh v·ª±c</th>
                  <th>T·ªï ch·ª©c</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Post</th>
                  <th>ƒê√£ ƒëƒÉng k√Ω</th>
                  <th>Tham d·ª±</th>
                  <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="json-view">
            <pre id="json-student">[]</pre>
          </div>
        </div>

        <div class="empty-state" id="empty-student" style="display: none">
          <div class="empty-state-icon">üì≠</div>
          <p>Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông n√†o</p>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "https://pbl6-backend-iy5q.onrender.com/api";

      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active class from all buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName).classList.add("active");

        // Add active class to clicked button
        event.target.classList.add("active");
      }

      function resetForm(type) {
        if (type === "all") {
          document.getElementById("status-all").value = "";
          document.getElementById("post-status-all").value = "";
          document.getElementById("field-all").value = "";
          document.getElementById("org-all").value = "";
          document.getElementById("title-all").value = "";
          document.getElementById("results-all").style.display = "none";
          document.getElementById("empty-all").style.display = "none";
          document.getElementById("error-all").classList.remove("show");
        } else {
          document.getElementById("student-id").value = "";
          document.getElementById("status-student").value = "";
          document.getElementById("post-status-student").value = "";
          document.getElementById("field-student").value = "";
          document.getElementById("org-student").value = "";
          document.getElementById("title-student").value = "";
          document.getElementById("results-student").style.display = "none";
          document.getElementById("empty-student").style.display = "none";
          document.getElementById("error-student").classList.remove("show");
        }
      }

      function showError(type, message) {
        const errorEl = document.getElementById(`error-${type}`);
        errorEl.textContent = `‚ùå ${message}`;
        errorEl.classList.add("show");
      }

      function hideError(type) {
        document.getElementById(`error-${type}`).classList.remove("show");
      }

      async function searchAllActivities(e) {
        e.preventDefault();
        hideError("all");

        const status = document.getElementById("status-all").value;
        const post_status = document.getElementById("post-status-all").value;
        const field_id = document.getElementById("field-all").value;
        const org_unit_id = document.getElementById("org-all").value;
        const title = document.getElementById("title-all").value;

        // Validate post_status
        if (post_status && post_status !== "true" && post_status !== "false") {
          showError(
            "all",
            "Gi√° tr·ªã tr·∫°ng th√°i post kh√¥ng h·ª£p l·ªá (ph·∫£i l√† true ho·∫∑c false)"
          );
          return;
        }

        // Build query string
        const params = new URLSearchParams();
        if (status) params.append("status", status);
        if (field_id) params.append("field_id", field_id);
        if (org_unit_id) params.append("org_unit_id", org_unit_id);
        if (title) params.append("title", title);

        const url = `${API_BASE_URL}/activities/filter?${params.toString()}`;

        document.getElementById("loading-all").classList.add("show");
        document.getElementById("results-all").style.display = "none";
        document.getElementById("empty-all").style.display = "none";

        try {
          // Prepare request options with POST body if post_status is selected
          const options = {};
          if (post_status) {
            options.method = "POST";
            options.headers = {
              "Content-Type": "application/json",
            };
            // Convert string 'true'/'false' to boolean
            options.body = JSON.stringify({
              status: post_status === "true" ? true : false,
            });
            console.log("[Search All Activities] POST body:", options.body);
          }

          const response = await fetch(
            url,
            Object.keys(options).length > 0 ? options : undefined
          );
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          displayResultsAll(data);
        } catch (error) {
          console.error("Error:", error);
          showError("all", error.message);
        } finally {
          document.getElementById("loading-all").classList.remove("show");
        }
      }

      async function searchStudentActivities(e) {
        e.preventDefault();
        hideError("student");

        const student_id = document.getElementById("student-id").value;
        if (!student_id) {
          showError("student", "Vui l√≤ng nh·∫≠p ID sinh vi√™n");
          return;
        }

        const status = document.getElementById("status-student").value;
        const post_status = document.getElementById(
          "post-status-student"
        ).value;
        const field_id = document.getElementById("field-student").value;
        const org_unit_id = document.getElementById("org-student").value;
        const title = document.getElementById("title-student").value;

        // Build query string
        const params = new URLSearchParams();
        if (status) params.append("status", status);
        if (field_id) params.append("field_id", field_id);
        if (org_unit_id) params.append("org_unit_id", org_unit_id);
        if (title) params.append("title", title);

        const url = `${API_BASE_URL}/activities/student/${student_id}/filter?${params.toString()}`;

        document.getElementById("loading-student").classList.add("show");
        document.getElementById("results-student").style.display = "none";
        document.getElementById("empty-student").style.display = "none";

        try {
          // Prepare request options with POST body if post_status is selected
          const options = {
            headers: {
              Authorization: `Bearer ${getToken()}`,
            },
          };

          if (post_status) {
            options.method = "POST";
            options.headers["Content-Type"] = "application/json";
            // Convert string 'true'/'false' to boolean
            options.body = JSON.stringify({
              status: post_status === "true" ? true : false,
            });
          }

          const response = await fetch(url, options);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          displayResultsStudent(data);
        } catch (error) {
          console.error("Error:", error);
          showError("student", error.message);
        } finally {
          document.getElementById("loading-student").classList.remove("show");
        }
      }

      function getStatusClass(status) {
        const statusMap = {
          "ch·ªù duy·ªát": "status-pending",
          "ch∆∞a t·ªï ch·ª©c": "status-approved",
          "ƒëang t·ªï ch·ª©c": "status-in_progress",
          "ƒë√£ t·ªï ch·ª©c": "status-completed",
          "t·ª´ ch·ªëi": "status-rejected",
          "h·ªßy ho·∫°t ƒë·ªông": "status-cancelled",
        };
        return statusMap[status] || "status-pending";
      }

      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function displayResultsAll(data) {
        const results = data.data || [];
        const count = data.count || 0;

        if (count === 0) {
          document.getElementById("empty-all").style.display = "block";
          return;
        }

        document.getElementById("count-all").textContent = `${count} k·∫øt qu·∫£`;
        document.getElementById("json-all").textContent = JSON.stringify(
          results,
          null,
          2
        );

        const tbody = document.querySelector("#table-all tbody");
        tbody.innerHTML = "";

        results.forEach((activity) => {
          const postBadge = activity.post_status
            ? '<span class="status-badge" style="background: #d4edda; color: #155724;">‚úì ƒê√£</span>'
            : '<span class="status-badge" style="background: #f8d7da; color: #721c24;">‚úó Ch∆∞a</span>';

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td><strong>${activity.title || "-"}</strong></td>
                    <td>${
                      activity.field_id?.name || activity.field_id || "-"
                    }</td>
                    <td>${
                      activity.org_unit_id?.name || activity.org_unit_id || "-"
                    }</td>
                    <td><span class="status-badge ${getStatusClass(
                      activity.status
                    )}">${activity.status}</span></td>
                    <td>${postBadge}</td>
                    <td>${formatDate(activity.start_time)}</td>
                    <td>${activity.location || "-"}</td>
                `;
          tbody.appendChild(row);
        });

        document.getElementById("results-all").style.display = "block";
      }

      function displayResultsStudent(data) {
        const results = data.data || [];
        const count = data.count || 0;

        if (count === 0) {
          document.getElementById("empty-student").style.display = "block";
          return;
        }

        document.getElementById(
          "count-student"
        ).textContent = `${count} k·∫øt qu·∫£`;
        document.getElementById("json-student").textContent = JSON.stringify(
          results,
          null,
          2
        );

        const tbody = document.querySelector("#table-student tbody");
        tbody.innerHTML = "";

        results.forEach((activity) => {
          const registered = activity.registration ? "‚úì" : "‚úó";
          const attended = activity.attendance ? "‚úì" : "‚úó";
          const postBadge = activity.post_status
            ? '<span class="status-badge" style="background: #d4edda; color: #155724;">‚úì ƒê√£</span>'
            : '<span class="status-badge" style="background: #f8d7da; color: #721c24;">‚úó Ch∆∞a</span>';

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td><strong>${activity.title || "-"}</strong></td>
                    <td>${
                      activity.field_id?.name || activity.field_id || "-"
                    }</td>
                    <td>${
                      activity.org_unit_id?.name || activity.org_unit_id || "-"
                    }</td>
                    <td><span class="status-badge ${getStatusClass(
                      activity.status
                    )}">${activity.status}</span></td>
                    <td>${postBadge}</td>
                    <td style="text-align: center;">${registered}</td>
                    <td style="text-align: center;">${attended}</td>
                    <td>${formatDate(activity.start_time)}</td>
                `;
          tbody.appendChild(row);
        });

        document.getElementById("results-student").style.display = "block";
      }

      function getToken() {
        // L·∫•y token t·ª´ localStorage (n·∫øu l∆∞u t·ª´ l·∫ßn ƒëƒÉng nh·∫≠p)
        return localStorage.getItem("token") || "";
      }

      // Log th√¥ng tin API
      console.log("API Base URL:", API_BASE_URL);
      console.log("T·∫•t c·∫£ ho·∫°t ƒë·ªông: GET /api/activities/filter");
      console.log(
        "Ho·∫°t ƒë·ªông sinh vi√™n: GET /api/activities/student/{studentId}/filter"
      );
    </script>
  </body>
</html>
