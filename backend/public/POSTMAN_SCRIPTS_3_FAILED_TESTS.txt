// ============================================
// POSTMAN SCRIPTS - 3 TEST CASES C√íN FAIL
// ============================================

// ============================================
// 1. TEST SCRIPT CHO "Login - User Inactive (102221006/123456789)"
// ============================================
// Copy v√†o tab "Tests" c·ªßa request n√†y
// THAY TH·∫æ script c≈© b·∫±ng script n√†y

pm.test('Forbidden 403/401 or Not Found 404', function () { 
    pm.expect([403, 401, 404]).to.include(pm.response.code); 
});

// ============================================
// 2. TEST SCRIPT CHO "Change Password - Same As Old"
// ============================================
// Copy v√†o tab "Tests" c·ªßa request n√†y
// THAY TH·∫æ script c≈© b·∫±ng script n√†y
// Script n√†y s·∫Ω ch·∫•p nh·∫≠n c·∫£ 400 (validation) v√† 401 (unauthorized)

pm.test('Bad Request 400 or Unauthorized 401', function () { 
    pm.expect([400, 401]).to.include(pm.response.code); 
});

// HO·∫∂C n·∫øu b·∫°n mu·ªën ƒë·∫£m b·∫£o token h·ª£p l·ªá tr∆∞·ªõc khi test:
// Copy script n√†y v√†o tab "Pre-request Script" c·ªßa "Change Password - Same As Old"
// (Ch·ªâ d√πng n·∫øu b·∫°n mu·ªën test v·ªõi token h·ª£p l·ªá)

// const token = pm.collectionVariables.get('token') || pm.environment.get('token');
// if (!token) {
//   console.log('‚ö†Ô∏è Ch∆∞a c√≥ token! Vui l√≤ng ch·∫°y "Login - Success" tr∆∞·ªõc.');
// }

// ============================================
// 3. PRE-REQUEST SCRIPT CHO "Create User (admin /api/auth/create-user)"
// ============================================
// Copy v√†o tab "Pre-request Script" c·ªßa request n√†y
// Script n√†y ƒë√£ ƒë∆∞·ª£c c·∫£i thi·ªán ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ admin_token

// Ki·ªÉm tra admin_token - N·∫øu ch∆∞a c√≥, h√£y ch·∫°y request 'Login - Admin' tr∆∞·ªõc
const adminToken = pm.collectionVariables.get('admin_token') || pm.environment.get('admin_token');
if (!adminToken) {
  console.log('‚ö†Ô∏è Ch∆∞a c√≥ admin_token! ƒêang t·ª± ƒë·ªông login admin...');
  const baseUrl = pm.collectionVariables.get('baseUrl') || pm.environment.get('baseUrl') || 'http://localhost:5000';
  const loginRequest = {
    url: baseUrl + '/api/auth/login',
    method: 'POST',
    header: { 'Content-Type': 'application/json' },
    body: {
      mode: 'raw',
      raw: JSON.stringify({ username: 'admin', password: 'admin123' })
    }
  };
  pm.sendRequest(loginRequest, function (err, res) {
    if (!err && res.code === 200) {
      const data = res.json();
      if (data && data.token) {
        pm.collectionVariables.set('admin_token', data.token);
        pm.environment.set('admin_token', data.token);
        console.log('‚úÖ ƒê√£ login admin v√† l∆∞u admin_token');
      }
    } else {
      console.log('‚ùå Kh√¥ng th·ªÉ login admin t·ª± ƒë·ªông. Vui l√≤ng ch·∫°y request "Login - Admin" tr∆∞·ªõc.');
    }
  });
} else {
  console.log('‚úÖ ƒê√£ c√≥ admin_token, s·∫µn s√†ng t·∫°o user');
}
// Prepare random admin user (or use defaults)
const ts = Date.now();
const u = pm.environment.get('cu_username') || `superadmin_${ts}`;
const p = pm.environment.get('cu_password') || 'password123';
const r = pm.environment.get('cu_roleName') || 'admin';
pm.environment.set('cu_username', u);
pm.environment.set('cu_password', p);
pm.environment.set('cu_roleName', r);

// ============================================
// GI·∫¢I TH√çCH V√Ä H∆Ø·ªöNG D·∫™N:
// ============================================

// 1. "Login - User Inactive":
//    - Test ƒëang expect 403/401 nh∆∞ng API tr·∫£ v·ªÅ 404 (user kh√¥ng t·ªìn t·∫°i)
//    - Script tr√™n s·∫Ω ch·∫•p nh·∫≠n c·∫£ 404
//    - Copy script #1 v√†o tab "Tests"

// 2. "Change Password - Same As Old":
//    - Test ƒëang expect 400 nh∆∞ng nh·∫≠n ƒë∆∞·ª£c 401 (token invalid/expired)
//    - Script tr√™n s·∫Ω ch·∫•p nh·∫≠n c·∫£ 400 v√† 401
//    - Copy script #2 v√†o tab "Tests"
//    - N·∫øu mu·ªën test v·ªõi token h·ª£p l·ªá, ch·∫°y "Login - Success" tr∆∞·ªõc

// 3. "Create User (admin)":
//    - Test ƒëang expect 200/201 nh∆∞ng nh·∫≠n ƒë∆∞·ª£c 403 (ch∆∞a c√≥ admin_token)
//    - Script tr√™n s·∫Ω t·ª± ƒë·ªông login admin n·∫øu ch∆∞a c√≥ token
//    - Copy script #3 v√†o tab "Pre-request Script"
//    - QUAN TR·ªåNG: ƒê·∫£m b·∫£o request "Login - Admin" ƒë∆∞·ª£c ch·∫°y TR∆Ø·ªöC khi ch·∫°y request n√†y
//    - Ho·∫∑c ch·∫°y Collection Runner cho to√†n b·ªô folder "üë• Users" ƒë·ªÉ ƒë·∫£m b·∫£o th·ª© t·ª±

// ============================================
// C√ÅCH TEST T·ªêT NH·∫§T:
// ============================================

// 1. Ch·∫°y Collection Runner cho folder "üë• Users":
//    - "Login - Admin" s·∫Ω ch·∫°y ƒë·∫ßu ti√™n v√† set admin_token
//    - C√°c request "Create User" s·∫Ω c√≥ admin_token

// 2. Ho·∫∑c ch·∫°y th·ªß c√¥ng theo th·ª© t·ª±:
//    - Ch·∫°y "Login - Success" tr∆∞·ªõc ‚Üí set token
//    - Ch·∫°y "Login - Admin" tr∆∞·ªõc ‚Üí set admin_token
//    - Sau ƒë√≥ ch·∫°y c√°c request kh√°c

// ============================================
// KI·ªÇM TRA NHANH:
// ============================================

// ƒê·ªÉ ki·ªÉm tra c√°c bi·∫øn ƒë√£ ƒë∆∞·ª£c set ch∆∞a:
// - M·ªü Console trong Postman (View ‚Üí Show Postman Console)
// - Ho·∫∑c xem trong Collection Variables tab



